<!DOCTYPE html>
<html>
<head>
  <link href="../lib/shifty/tests/qunit/qunit.css" rel="stylesheet" type="text/css" />
  <script src="../lib/shifty/tests/qunit/qunit.js"></script>
  <script src="../lib/require.js"></script><script>
  
  require([
      '../lib/underscore/underscore.js'
      ,'../lib/shifty/shifty.js'], 
      function () {
        
    require(['../src/rekapi.core.js'], function () {
      require(['../src/rekapi.actor.js'], function () {
        require(['../src/rekapi.canvas.js'
                ,'../src/rekapi.interpolate.js'], function () {
          setTimeout(runTests, 1);
        });
      });
    });
    
  });
  
  function setupTestKapi () {
    var sandbox
        ,kapi
        ,actor;

    sandbox = document.getElementById('sandbox');
    kapi = new Kapi(sandbox);

    kapi.canvas_style('background', '#ddd');
    kapi.height(300);
    kapi.width(500);
    
    return kapi;
  }
  
  function  setupTestActor (forKapi) {
    var actor;
    
    actor = new Kapi.Actor(forKapi, {
      'draw': function (canvas_context, state) {
        canvas_context.beginPath();
          canvas_context.arc(
            this.x || 0,
            this.y || 0,
            this.radius || 0,
            0,
            Math.PI*2, 
            true);
          canvas_context.fillStyle = this.color || '#f0f';
          canvas_context.fill();
          canvas_context.closePath();

          return this;
      }
    });
    
    forKapi.addActor(actor);
    return actor;
  }
  
  function runTests () {
    
    module('Single keyframe');
    
    test('Correctly interpolate Actor positions at various positions mid-frame', 
    function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      
      testActor.keyframe(0, {
        'x': 0
        ,'y': 0
      }).keyframe(1000, {
        'x': 100
        ,'y':100
      });
      
      
      testActor.calculatePosition(0);
      
      equals(testActor.get().x, 0, 
        'Value "x" was properly interpolated at position 0.0');
      equals(testActor.get().y, 0, 
        'Value "y" was properly interpolated at position 0.0');
      
      
      testActor.calculatePosition(500);
      
      equals(testActor.get().x, 50, 
        'Value "x" was properly interpolated at position 0.5');
      equals(testActor.get().y, 50, 
        'Value "y" was properly interpolated at position 0.5');


      testActor.calculatePosition(1000);

      equals(testActor.get().x, 100, 
        'Value "x" was properly interpolated at position 1.0');
      equals(testActor.get().y, 100, 
        'Value "y" was properly interpolated at position 1.0');
    });


    test('Tweens are only valid if there is a start point',
    function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);

      testActor.keyframe(0,{
        'x': 100
      }).keyframe(1000, {
        // Nothing!
      });

      testActor.calculatePosition(500);
      equals(testActor.get().x, undefined, 
          'Value only has a start point, therefore a calculated midpoint is undefined.');
    });
    
    
    test('Tweens are only valid if there is an end point',
    function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);

      testActor.keyframe(0,{
        // Nothing!
      }).keyframe(1000, {
        'x': 100
      });

      testActor.calculatePosition(500);
      equals(testActor.get().x, undefined, 
          'Value only has an end point, therefore a calculated midpoint is undefined.');
    });



    module('Multiple keyframes');
    
    test('Interpolate Actor positions at various positions mid-frame',
    function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      
      testActor.keyframe(1000, {
          'x': 0
          ,'y':0
      }).keyframe(2000, {
        'x': 100
        ,'y':100
      });
      
      testActor.calculatePosition(1000);
      
      equals(testActor.get().x, 0, 
        'Value "x" was properly interpolated at position 0.0');
      equals(testActor.get().y, 0, 
        'Value "y" was properly interpolated at position 0.0');
      
      
      testActor.calculatePosition(1500);
      
      equals(testActor.get().x, 50, 
        'Value "x" was properly interpolated at position 0.5');
      equals(testActor.get().y, 50, 
        'Value "y" was properly interpolated at position 0.5');
      
      
      testActor.calculatePosition(2000);
      
      equals(testActor.get().x, 100, 
        'Value "x" was properly interpolated at position 1.0');
      equals(testActor.get().y, 100, 
        'Value "y" was properly interpolated at position 1.0');
    });
    
    
    
    test('Applied easing is taken from the destination frame', 
    function () {
      var testKapi
          ,testActor
          ,tweenableComparator;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor.keyframe(0, {
        'x': 0
      }, 'linear').keyframe(1000, {
        'x': 100
      }, 'easeInSine').keyframe(2000, {
        'x': 200
      }, 'easeOutCirc');
      
      tweenableComparator = Tweenable.util.interpolate({
        'x': 0
      }, {
        'x': 100
      }, .5, 'easeInSine');
      
      testActor.calculatePosition(500);     
      equals(testActor.get().x, tweenableComparator.x, 
        'Value "x" was properly interpolated at position 0.5 with "easeInSine"');
        
      
      tweenableComparator = Tweenable.util.interpolate({
        'x': 100
      }, {
        'x': 200
      }, .5, 'easeOutCirc');

      testActor.calculatePosition(1500);
      equals(testActor.get().x, tweenableComparator.x, 
        'Value "x" was properly interpolated at position 0.5 with "easeOutCirc"');
      
    });


    module('Keyframe removal');

    test('Keyframes can be removed from the middle of the animation', 
        function () {

      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {})
        .keyframe(1000, {})
        .keyframe(2000, {});
      
      testActor.removeKeyframe(1000);
      
      equals(testActor._keyframeList[1000], undefined,
        'Keyframe 1000 no longer exists in _keyframeList');

      equals(testActor._keyframeList.indexOf(1000), -1,
          'Keyframe 1000 is no longer in _keyframeList');
    });
    
    test('Keyframes can be removed from the end of the animation', 
        function () {

      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {})
        .keyframe(1000, {})
        .keyframe(2000, {});
      
      testActor.removeKeyframe(2000);
      
      equals(testKapi._animationLength, 1000,
          'The animation length is shortened when the final keyframe is removed');
    });

    test('.removeAllKeyframes removes all keyframes', function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {})
        .keyframe(1000, {})
        .keyframe(2000, {});
      
      testActor.removeAllKeyframes();
      
      equals(testKapi._animationLength, 0, 'Animation length is 0');
      equals(testActor._keyframeList.length, 0, 
          'There are no keyframes in the keyframe list');
    
    });


    module('Keyframe modification');

    test('Original keyframe property is changed.' , function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {
          'x': 100
        }).keyframe(1000, {
          'x': 200
        });
      
      testActor.modifyKeyframe(0, {
        'x': 0
      });

      testActor.calculatePosition(500);
      equals(testActor.get().x, 100,
          'First keyframe was modified and factored into the position calculation');
    });


    module('Live copies');

    test('Live copy state and easing Objects point to the source keyframe\'s Objects.'
    ,function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {
          'x': 100
        }).keyframe(1000, {
          'x': 200
        }).liveCopy(2000, 0);

      ok(testActor._keyframes[0].position === testActor._keyframes[2000].position,
          'Live copy position Object is a reference to the source postition Object');

      ok(testActor._keyframes[0].easing === testActor._keyframes[2000].easing,
          'Live copy easing Object is a reference to the source easing Object');
    });


    test('Modifiying the target keyframe modifies the live copy.'
    ,function () {
      var testKapi
          ,testActor;

      testKapi = setupTestKapi();
      testActor = setupTestActor(testKapi);
      
      testActor
        .keyframe(0, {
          'x': 100
        }).keyframe(1000, {
          'x': 200
        }).liveCopy(2000, 0);

      testActor.modifyKeyframe(0, {
        'x': 50
      });

      equals(testActor._keyframes[0].position.x
          ,testActor._keyframes[2000].position.x
          ,'The live copy "x" property was modified when the original property was modified.');
    });
  }
  </script>
</head>
<body>
  <h1 id="qunit-header"><a href="https://github.com/jeremyckahn/rekapi">Rekapi</a></h1>
   <h2 id="qunit-banner"></h2>
   <div id="qunit-testrunner-toolbar"></div>
   <h2 id="qunit-userAgent"></h2>
   <ol id="qunit-tests"></ol>
   <div id="qunit-fixture"></div>
  <canvas id="sandbox"></canvas>
</body>
</html>
