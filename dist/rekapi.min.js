/**
 * Rekapi - Rewritten Kapi. v0.1.12
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(e){function j(a){return a.sort(function(a,b){return a-b})}function c(a,b){return Math.floor(b/a._animationLength)}function i(a){return k()-a._loopTimestamp}function b(a,b){return b>=a._timesToIterate&&a._timesToIterate!==-1}function h(a,c){b(a,c)&&a.stop()}function f(a,c,d){return b(a,d)?a._animationLength:c%a._animationLength}function g(a){var b=i(a),d;d=c(a,b);b=f(a,b,d);h(a,d);a.render(b)}function m(a){a._loopId=setTimeout(function(){m(a);g(a)},1E3/a.config.fps)}if(!_)throw"underscore.js is required for Kapi.";
if(!Tweenable)throw"shifty.js is required for Kapi.";var d,l,k;l={fps:30,height:150,width:300};k=Tweenable.util.now;d=e.Kapi||function(a,b){this.canvas=a;this._context=a.getContext("2d");this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,b);_.defaults(this.config,l);_.each(["height","width"],function(a){this.config[a]&&
(this["canvas_"+a](this.config[a]),delete this.config[a])},this);return this};d.prototype.addActor=function(a,b){if(!_.contains(this._actors,a))a.kapi=this,a.fps=this.framerate(),a.set(b||{}),this._actors[a.id]=a,this._drawOrder.push(a.id),a.setup();return this};d.prototype.getActor=function(a){return this._actors[a]};d.prototype.removeActor=function(a){delete this._actors[a.id];delete a.kapi;this._drawOrder=_.without(this._drawOrder,a.id);a.teardown();this.updateInternalState();return this};d.prototype.play=
function(a){clearTimeout(this._loopId);this._playState==="paused"?this._loopTimestamp+=k()-this._pausedAtTime:this._loopTimestamp=k();this._timesToIterate=a||-1;this._playState="playing";m(this);_.each(this._actors,function(a){a._state.isPaused&&a.resume()});return this};d.prototype.pause=function(){this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=k();_.each(this._actors,function(a){a._state.isTweening&&a.pause()});return this};d.prototype.stop=function(a){this._playState="stopped";
clearTimeout(this._loopId);a===true&&this.canvas_clear();_.each(this._actors,function(a){a.stop()});return this};d.prototype.isPlaying=function(){return this._playState==="playing"};d.prototype.animationLength=function(){return this._animationLength};d.prototype.actorCount=function(){return this._drawOrder.length};d.prototype.framerate=function(a){if(a)this.config.fps=a;return this.config.fps};d.prototype.render=function(a){this.calculateActorPositions(a);this.draw();this._lastRenderedMillisecond=
a;return this};d.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};d.prototype.calculateActorPositions=function(a){var b,c;c=this._drawOrder.length;for(b=0;b<c;b++)this._actors[this._drawOrder[b]].calculatePosition(a);return this};d.prototype.draw=function(){var a,b,c,d;this.canvas_clear();b=this._drawOrder.length;d=this.canvas_context();for(a=0;a<b;a++)c=this._actors[this._drawOrder[a]],c.isShowing()&&c.draw(d,c.get());return this};d.prototype.updateInternalState=
function(){var a;a=[0];_.each(this._drawOrder,function(b){a=a.concat(a,this._actors[b].keyframeList())},this);this._animationLength=Math.max.apply(Math,a);return this};d.prototype.moveActorToLayer=function(a,b){if(b<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a};d.util={};_.extend(d.util,{noop:function(){},sortNumerically:j});if(typeof KAPI_DEBUG!=="undefined"&&KAPI_DEBUG===true)d._private={sortNumerically:j,calculateLoopPosition:f,
renderCurrentMillisecond:g,tick:m,determineCurrentLoopIteration:c,calculateTimeSinceStart:i,isAnimationComplete:b,updatePlayState:h};e.Kapi=d})(this);
(function(e){function j(b,c){_.each(c,function(c,h){c===void 0||c===null?delete b[h]:b[h]=c})}var c,i;c=e.Kapi;i=0;c.Actor=function(b){b=b||{};this.constructor.call(this);_.extend(this,{_keyframes:{},_keyframeList:[],_data:{},_isShowing:false,_isPersisting:false,id:i++,setup:b.setup||c.util.noop,draw:b.draw||c.util.noop,teardown:b.teardown||c.util.noop});return this};e=function(){};e.prototype=Tweenable.prototype;c.Actor.prototype=new e;c.Actor.prototype.keyframe=function(b,h,f){var g;f||(f="linear");
typeof f==="string"&&(g=f,f={},_.each(h,function(b,c){f[c]=g}));_.each(h,function(b,c){f[c]=f[c]||"linear"});this._keyframes[b]={position:h,easing:f};this._keyframeList.push(b);c.util.sortNumerically(this._keyframeList);this.kapi.updateInternalState();return this};c.Actor.prototype.liveCopy=function(b,c){var f;typeof c==="undefined"&&(c=_.last(this._keyframeList));this._keyframes.hasOwnProperty(c)&&(f=this._keyframes[c],this.keyframe(b,f.position,f.easing));return this};c.Actor.prototype.modifyKeyframe=
function(b,c,f){b=this._keyframes[b];j(b.position,c);f&&j(b.easing,f);return this};c.Actor.prototype.removeKeyframe=function(b){if(this._keyframeList.indexOf(b)!==-1)this._keyframeList=_.without(this._keyframeList,b),delete this._keyframes[b],this.kapi.updateInternalState();return this};c.Actor.prototype.removeAllKeyframes=function(){var b;b=this._keyframeList.slice(0);_.each(b,function(b){this.removeKeyframe(b)},this);return this};c.Actor.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,
b)};c.Actor.prototype.show=function(b){this._isShowing=true;this._isPersisting=!!b;return this};c.Actor.prototype.hide=function(b){this._isShowing=false;if(b===true)this._isPersisting=false;return this};c.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};c.Actor.prototype.calculatePosition=function(b){var c,f,g,e,d;c=this._keyframeList;f=_.first(c);g=_.last(c);this.hide();if(f<=b&&b<=g){this.show();f=this._keyframes;a:{d=this._keyframeList;e=d.length;for(g=1;g<e;g++)if(d[g]>=
b){g-=1;break a}g=-1}e=c[g];d=c[g+1];this.set(f[c[g]].position).interpolate(f[c[g+1]].position,(b-e)/(d-e),f[c[g+1]].easing)}return this};c.Actor.prototype.keyframeList=function(){return this._keyframeList};c.Actor.prototype.data=function(b){if(b)this._data=b;return this._data};_.each(["tween","to"],function(b){c.Actor.prototype[b]=function(){this.show(true);Tweenable.prototype[b].apply(this,arguments)}},this)})(this);
(function(e){function j(c,e,b){typeof b!=="undefined"&&(c[e]=b,c.style[e]=b+"px");return c[e]}e=e.Kapi;e.prototype.canvas_context=function(){return this._context};e.prototype.canvas_height=function(c){return j(this.canvas,"height",c)};e.prototype.canvas_width=function(c){return j(this.canvas,"width",c)};e.prototype.canvas_style=function(c,e){typeof e!=="undefined"&&(this.canvas.style[c]=e);return this.canvas.style[c]};e.prototype.canvas_clear=function(){this.canvas_context().clearRect(0,0,this.canvas_width(),
this.canvas_height());return this}})(this);
(function(e){function j(c,i,b,h){var f=/^(__r__|__g__|__b__)/,g;g={};_.each(c,function(j,d){var l;l=d.match(f)?Tweenable.prototype.formula[h[d.slice(5)]]:Tweenable.prototype.formula[h[d]];typeof i[d]!=="undefined"&&(g[d]=e.Tweenable.util.tweenProp(c[d],i[d],l,b))});return g}e.Kapi.Actor.prototype.interpolate=function(c,i,b){var h=this.get(),f;f=e.Tweenable.util.simpleCopy({},h);e.Tweenable.util.applyFilter("tweenCreated",f,[f,h,c]);e.Tweenable.util.applyFilter("beforeTween",f,[f,h,c]);i=j(h,c,i,b);
e.Tweenable.util.applyFilter("afterTween",i,[i,h,c]);this.set(i);return i}})(this);
