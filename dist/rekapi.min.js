/**
 * Rekapi - Rewritten Kapi. v0.1.15
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(f){function h(a){return a.sort(function(a,b){return a-b})}function d(a,b){return Math.floor(b/a._animationLength)}function g(a){return j()-a._loopTimestamp}function b(a,b){return b>=a._timesToIterate&&-1!==a._timesToIterate}function i(a,c){b(a,c)&&a.stop()}function e(a,c,e){return b(a,e)?a._animationLength:c%a._animationLength}function m(a){var b=g(a),c;c=d(a,b);b=e(a,b,c);i(a,c);a.render(b)}function l(a){a._loopId=setTimeout(function(){l(a);m(a)},1E3/a.config.fps)}if(!_)throw"underscore.js is required for Kapi.";
if(!Tweenable)throw"shifty.js is required for Kapi.";var c,k,j;k={fps:30,height:150,width:300};j=Tweenable.util.now;c=f.Kapi||function(a,b){this.canvas=a;this._context=a.getContext("2d");this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,b);_.defaults(this.config,k);_.each(["height","width"],function(a){this.config[a]&&
(this["canvas_"+a](this.config[a]),delete this.config[a])},this);return this};c.prototype.addActor=function(a,b){if(!_.contains(this._actors,a))a.kapi=this,a.fps=this.framerate(),a.set(b||{}),this._actors[a.id]=a,this._drawOrder.push(a.id),a.setup();return this};c.prototype.getActor=function(a){return this._actors[a]};c.prototype.removeActor=function(a){delete this._actors[a.id];delete a.kapi;this._drawOrder=_.without(this._drawOrder,a.id);a.teardown();this.updateInternalState();return this};c.prototype.play=
function(a){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(j()-this._pausedAtTime):j();this._timesToIterate=a||-1;this._playState="playing";l(this);_.each(this._actors,function(a){a._state.isPaused&&a.resume()});return this};c.prototype.playFrom=function(a,b){this.play(b);this._loopTimestamp=j()-a;return this};c.prototype.playFromCurrent=function(a){return this.playFrom(this._lastRenderedMillisecond,a)};c.prototype.pause=function(){this._playState="paused";
clearTimeout(this._loopId);this._pausedAtTime=j();_.each(this._actors,function(a){a._state.isTweening&&a.pause()});return this};c.prototype.stop=function(a){this._playState="stopped";clearTimeout(this._loopId);!0===a&&this.canvas_clear();_.each(this._actors,function(a){a.stop()});return this};c.prototype.isPlaying=function(){return"playing"===this._playState};c.prototype.animationLength=function(){return this._animationLength};c.prototype.actorCount=function(){return this._drawOrder.length};c.prototype.framerate=
function(a){if(a)this.config.fps=a;return this.config.fps};c.prototype.render=function(a){this.calculateActorPositions(a);this.draw();this._lastRenderedMillisecond=a;return this};c.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};c.prototype.calculateActorPositions=function(a){var b,c;c=this._drawOrder.length;for(b=0;b<c;b++)this._actors[this._drawOrder[b]].calculatePosition(a);return this};c.prototype.draw=function(){var a,b,c,e;this.canvas_clear();b=this._drawOrder.length;
e=this.canvas_context();for(a=0;a<b;a++)c=this._actors[this._drawOrder[a]],c.isShowing()&&c.draw(e,c.get());return this};c.prototype.updateInternalState=function(){var a;a=[0];_.each(this._drawOrder,function(b){a=a.concat(a,this._actors[b].keyframeList());a=_.uniq(a)},this);this._animationLength=Math.max.apply(Math,a);return this};c.prototype.moveActorToLayer=function(a,b){if(b<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a};c.util=
{};_.extend(c.util,{noop:function(){},sortNumerically:h});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)c._private={sortNumerically:h,calculateLoopPosition:e,renderCurrentMillisecond:m,tick:l,determineCurrentLoopIteration:d,calculateTimeSinceStart:g,isAnimationComplete:b,updatePlayState:i};f.Kapi=c})(this);
(function(f){function h(b,d){_.each(d,function(e,d){void 0===e||null===e?delete b[d]:b[d]=e})}var d,g;d=f.Kapi;g=0;d.Actor=function(b){b=b||{};this.constructor.call(this);_.extend(this,{_keyframes:{},_keyframeList:[],_data:{},_isShowing:!1,_isPersisting:!1,id:g++,setup:b.setup||d.util.noop,draw:b.draw||d.util.noop,teardown:b.teardown||d.util.noop});return this};f=function(){};f.prototype=Tweenable.prototype;d.Actor.prototype=new f;d.Actor.prototype.keyframe=function(b,i,e){var f;e||(e="linear");"string"===
typeof e&&(f=e,e={},_.each(i,function(b,c){e[c]=f}));_.each(i,function(b,c){e[c]=e[c]||"linear"});this._keyframes[b]={position:i,easing:e};this._keyframeList.push(b);d.util.sortNumerically(this._keyframeList);this.kapi.updateInternalState();return this};d.Actor.prototype.liveCopy=function(b,d){var e;"undefined"===typeof d&&(d=_.last(this._keyframeList));this._keyframes.hasOwnProperty(d)&&(e=this._keyframes[d],this.keyframe(b,e.position,e.easing));return this};d.Actor.prototype.modifyKeyframe=function(b,
d,e){b=this._keyframes[b];h(b.position,d);e&&h(b.easing,e);return this};d.Actor.prototype.removeKeyframe=function(b){if(-1!==this._keyframeList.indexOf(b))this._keyframeList=_.without(this._keyframeList,b),delete this._keyframes[b],this.kapi.updateInternalState();return this};d.Actor.prototype.removeAllKeyframes=function(){var b;b=this._keyframeList.slice(0);_.each(b,function(b){this.removeKeyframe(b)},this);return this};d.Actor.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,
b)};d.Actor.prototype.show=function(b){this._isShowing=!0;this._isPersisting=!!b;return this};d.Actor.prototype.hide=function(b){this._isShowing=!1;if(!0===b)this._isPersisting=!1;return this};d.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};d.Actor.prototype.calculatePosition=function(b){var d,e,f,g,c;e=this._keyframeList;f=_.first(e);c=_.last(e);this.hide();if(f<=b&&b<=c){this.show();f=this._keyframes;a:{g=this._keyframeList;d=g.length;for(c=1;c<d;c++)if(g[c]>=
b){c-=1;break a}c=-1}d=e[c];g=e[c+1];g=(b-d)/(g-d);var h,j,a;h=this._keyframeList;j=this._keyframes;b={};d={};for(a=c;0<=a;a--)_.defaults(b,j[h[a]].position),_.defaults(d,j[h[a]].easing);e=_.extend({},f[e[c+1]]);_.defaults(e.position,b);_.defaults(e.easing,d);this.set(b).interpolate(e.position,g,e.easing)}return this};d.Actor.prototype.keyframeList=function(){return this._keyframeList};d.Actor.prototype.data=function(b){if(b)this._data=b;return this._data};_.each(["tween","to"],function(b){d.Actor.prototype[b]=
function(){this.show(!0);Tweenable.prototype[b].apply(this,arguments)}},this)})(this);
(function(f){function h(d,f,b){"undefined"!==typeof b&&(d[f]=b,d.style[f]=b+"px");return d[f]}f=f.Kapi;f.prototype.canvas_context=function(){return this._context};f.prototype.canvas_height=function(d){return h(this.canvas,"height",d)};f.prototype.canvas_width=function(d){return h(this.canvas,"width",d)};f.prototype.canvas_style=function(d,f){"undefined"!==typeof f&&(this.canvas.style[d]=f);return this.canvas.style[d]};f.prototype.canvas_clear=function(){this.canvas_context().clearRect(0,0,this.canvas_width(),
this.canvas_height());return this}})(this);
(function(f){function h(d,g,b,i){var e=/^(__r__|__g__|__b__)/,h;h={};_.each(d,function(l,c){var k;k=c.match(e)?Tweenable.prototype.formula[i[c.slice(5)]]:Tweenable.prototype.formula[i[c]];"undefined"!==typeof g[c]&&(h[c]=f.Tweenable.util.tweenProp(d[c],g[c],k,b))});return h}f.Kapi.Actor.prototype.interpolate=function(d,g,b){var i=this.get(),e;e=f.Tweenable.util.simpleCopy({},i);f.Tweenable.util.applyFilter("tweenCreated",e,[e,i,d]);f.Tweenable.util.applyFilter("beforeTween",e,[e,i,d]);g=h(i,d,g,b);
f.Tweenable.util.applyFilter("afterTween",g,[g,i,d]);this.set(g);return g}})(this);
