/*jslint browser: true, nomen: true, plusplus: true, undef: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.9.5
 * https://github.com/jeremyckahn/rekapi
 *
 * By Jeremy Kahn (jeremyckahn@gmail.com), with significant contributions from
 *   Franck Lecollinet
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore),
 *   Shifty.js (https://github.com/jeremyckahn/shifty).
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(s){function k(d,a,c,g){c.each(d._events[a],function(a){a(d,g)})}function t(){}var z=function(d,a,c){function g(e,b){return Math.floor(b/e._animationLength)}function j(e){return h()-e._loopTimestamp}function m(e,b){return b>=e._timesToIterate&&-1!==e._timesToIterate}function q(e,b){m(e,b)&&(e.stop(),k(e,"animationComplete",a))}function i(e,b,a){return m(e,a)?e._animationLength:b%e._animationLength}function l(b){var a=j(b),h=g(b,a),a=i(b,a,h);b.update(a);q(b,h)}function p(e){var a=function(){p(e);
l(e)};e._loopId=e._scheduleUpdate.call?e._scheduleUpdate.call(b,a,1E3/e.config.fps):setTimeout(a,1E3/e.config.fps)}function n(e){return 60!==e?b.setTimeout:b.requestAnimationFrame||b.webkitRequestAnimationFrame||b.oRequestAnimationFrame||b.msRequestAnimationFrame||b.mozCancelRequestAnimationFrame&&b.mozRequestAnimationFrame||b.setTimeout}function o(e){return 60!==e?b.clearTimeout:b.cancelAnimationFrame||b.webkitCancelAnimationFrame||b.oCancelAnimationFrame||b.msCancelAnimationFrame||b.mozCancelRequestAnimationFrame||
b.clearTimeout}function r(e){e._cancelUpdate.call?e._cancelUpdate.call(b,e._loopId):clearTimeout(e._loopId)}var b=Function("return this")(),h=c.util.now,f={fps:60},c=d.Kapi||function(b){this.config=b||{};this.context=this.config.context||{};this._actors={};this._playState="stopped";this._events={animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeUpdate:[],afterUpdate:[],addActor:[],removeActor:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=
this._loopId=null;this._lastUpdatedMillisecond=0;a.extend(this.config,b);a.defaults(this.config,f);this._scheduleUpdate=n(this.config.fps);this._cancelUpdate=o(this.config.fps);a.each(this._contextInitHook,function(b){b.call(this)},this);return this};c.prototype._contextInitHook={};c.prototype._recalculateAnimationLength=function(){var b=[];a.each(this._actors,function(a){b.push(a.getEnd())});this._animationLength=Math.max.apply(Math,b);return this};c.prototype.addActor=function(b){if(!a.contains(this._actors,
b))b.context()||b.context(this.context),b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._recalculateAnimationLength(),b.setup(),k(this,"addActor",a,b);return this};c.prototype.getActor=function(b){return this._actors[b]};c.prototype.getActorIds=function(){return a.pluck(this._actors,"id")};c.prototype.getAllActors=function(){return a.clone(this._actors)};c.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;b.teardown();this._recalculateAnimationLength();k(this,
"removeActor",a,b);return this};c.prototype.play=function(b){r(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(h()-this._pausedAtTime):h();this._timesToIterate=b||-1;this._playState="playing";p(this);a.each(this._actors,function(b){b._state.isPaused&&b.resume()});k(this,"playStateChange",a);k(this,"play",a);return this};c.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=h()-b;return this};c.prototype.playFromCurrent=function(b){return this.playFrom(this._lastUpdatedMillisecond,
b)};c.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";r(this);this._pausedAtTime=h();a.each(this._actors,function(b){b._state.isTweening&&b.pause()});k(this,"playStateChange",a);k(this,"pause",a);return this};c.prototype.stop=function(){this._playState="stopped";r(this);a.each(this._actors,function(b){b.stop()});k(this,"playStateChange",a);k(this,"stop",a);return this};c.prototype.isPlaying=function(){return"playing"===this._playState};c.prototype.animationLength=
function(){return this._animationLength};c.prototype.lastPositionUpdated=function(){return this._lastUpdatedMillisecond/this._animationLength};c.prototype.actorCount=function(){return a.size(this._actors)};c.prototype.framerate=function(b){if(b)this.config.fps=b,this._scheduleUpdate=n(this.config.fps),this._cancelUpdate=o(this.config.fps);return this.config.fps};c.prototype.update=function(b){k(this,"beforeUpdate",a);a.each(this._actors,function(a){a.updateState(b);"function"===typeof a.update&&a.update(a.context(),
a.get())});this._lastUpdatedMillisecond=b;k(this,"afterUpdate",a);return this};c.prototype.on=function(b,a){if(this._events[b])return this._events[b].push(a),this};c.prototype.off=function(b,h){if(this._events[b])return this._events[b]=h?a.without(this._events[b],h):[],this};c.prototype.exportTimeline=function(){var b={duration:this._animationLength,actors:{}};a.each(this._actors,function(a){b.actors[a.id]=a.exportTimeline()},this);return b};c.util={};a.extend(c.util,{calculateLoopPosition:i,calculateTimeSinceStart:j});
if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)c._private={calculateLoopPosition:i,updateToCurrentMillisecond:l,tick:p,determineCurrentLoopIteration:g,calculateTimeSinceStart:j,isAnimationComplete:m,updatePlayState:q};d.Kapi=c},A=function(d,a,c){function g(b){return b.sort(function(b,a){return b-a})}function j(b,a){var f=b._timelinePropertyCacheIndex,e=f.length,c;for(c=1;c<e;c++)if(f[c]>=a)return c-1;return-1}function m(b){a.each(b._propertyTracks,function(h,f){b._propertyTracks[f]=a.sortBy(b._propertyTracks[f],
function(b){return b.millisecond})})}function k(b){a.each(b._timelinePropertyCaches,function(h,f){var e=i(b,+f);a.defaults(h,e)})}function i(b,h){var f={};a.each(b._propertyTracks,function(b,c){var d=null;a.find(b,function(b){b.millisecond>h?f[c]=d:b.millisecond===h&&(f[c]=b);d=b;return!!f[c]});if(!f[c]){var l=a.last(b);l&&l.millisecond<=h&&(f[c]=l)}});return f}function l(b){a.each(b._propertyTracks,function(b){a.each(b,function(a,c){a.linkToNext(b[c+1])})})}function p(b,h,c){return a.find(b._propertyTracks[h],
function(b){return b.millisecond===c})}function n(b){b._timelinePropertyCaches={};a.each(b._keyframeProperties,function(a){b._timelinePropertyCaches[a.millisecond]||(b._timelinePropertyCaches[a.millisecond]={});b._timelinePropertyCaches[a.millisecond][a.name]=a},b);b._timelinePropertyCacheIndex=a.keys(b._timelinePropertyCaches);a.each(b._timelinePropertyCacheIndex,function(a,c){b._timelinePropertyCacheIndex[c]=+a},b);g(b._timelinePropertyCacheIndex);k(b);l(b)}var o=d.Kapi,d=o.Actor=function(b){b=
b||{};c.call(this);a.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:a.uniqueId(),setup:b.setup||t,update:b.update||t,teardown:b.teardown||t});b.context&&this.context(b.context);return this},r=function(){};r.prototype=c.prototype;d.prototype=new r;d.prototype.context=function(b){if(b)this._context=b;return this._context};d.prototype.keyframe=function(b,c,f){var e,f=f||"linear";"string"===typeof f&&(e=f,f={},a.each(c,function(b,
a){f[a]=e}));a.each(c,function(b,a){f[a]=f[a]||"linear"});a.each(c,function(a,c){var h=new o.KeyframeProperty(this,b,c,a,f[c]);this._keyframeProperties[h.id]=h;this._propertyTracks[c]||(this._propertyTracks[c]=[]);this._propertyTracks[c].push(h);m(this)},this);this.kapi&&this.kapi._recalculateAnimationLength();n(this);return this};d.prototype.getKeyframeProperty=function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};d.prototype.modifyKeyframeProperty=
function(b,a,c){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(c);m(this);n(this);return this};d.prototype.getTrackNames=function(){return a.keys(this._propertyTracks)};d.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};d.prototype.copyProperties=function(b,c){var f={},e={};a.each(this._propertyTracks,function(b,a){var d=p(this,a,c);if(d)f[a]=d.value,e[a]=d.easing},this);this.keyframe(b,f,e);return this};
d.prototype.wait=function(b){var c=this.getEnd();if(b<=c)return this;var c=this.getEnd(),f=i(this,this.getEnd()),e={},d={};a.each(f,function(b,a){e[a]=b.value;d[a]=b.easing});this.removeKeyframe(c);this.keyframe(c,e,d);this.keyframe(b,e,d);return this};d.prototype.getStart=function(){var b=[];a.each(this._propertyTracks,function(a){a.length&&b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};d.prototype.getEnd=function(){var b=0;a.each(this._propertyTracks,function(c){if(c.length)c=
a.last(c).millisecond,c>b&&(b=c)},this);return b};d.prototype.getLength=function(){return this.getEnd()-this.getStart()};d.prototype.hasKeyframeAt=function(b,c){var f=this._propertyTracks;if(c){if(!a.has(f,c))return!1;f=a.pick(f,c)}return void 0!==a.find(f,function(a,c){return void 0!==p(this,c,b)},this)};d.prototype.modifyKeyframe=function(b,c,f){f=f||{};a.each(this._propertyTracks,function(a,d){var l=p(this,d,b);l&&l.modifyWith({value:c[d],easing:f[d]})},this);return this};d.prototype.removeKeyframe=
function(b){a.each(this._propertyTracks,function(c){var d=-1,e=!1;a.find(c,function(a){d++;return e=b===a.millisecond});e&&(c=c.splice(d,1)[0])&&delete this._keyframeProperties[c.id]},this);this.kapi&&this.kapi._recalculateAnimationLength();n(this);return this};d.prototype.removeAllKeyframeProperties=function(){a.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};d.prototype.updateState=function(b){var c=this.getStart(),d=this.getEnd();
if(c<=b&&b<=d){var c=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[j(this,b)]],e={};a.each(c,function(a,c){a&&(e[c]=a.getValueAt(b))});this.set(e)}return this};d.prototype.data=function(b){if(b)this._data=b;return this._data};d.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};a.each(this._propertyTracks,function(c,d){var e=b.propertyTracks[d]=[];a.each(c,function(b){e.push(b.exportPropertyData())})});
return b}},B=function(d,a,c){d=d.Kapi.KeyframeProperty=function(c,d,m,k,i){this.id=a.uniqueId("keyframeProperty_");this.ownerActor=c;this.millisecond=d;this.name=m;this.value=k;this.easing=i||"linear";this.nextProperty=null;return this};d.prototype.modifyWith=function(c){var d={};a.each(["millisecond","easing","value"],function(a){d[a]="undefined"===typeof c[a]?this[a]:c[a]},this);a.extend(this,d)};d.prototype.linkToNext=function(a){this.nextProperty=a||null};d.prototype.getValueAt=function(a){var d=
{},m={};this.nextProperty?(d[this.name]=this.value,m[this.name]=this.nextProperty.value,a=c.util.interpolate(d,m,(a-this.millisecond)/(this.nextProperty.millisecond-this.millisecond),this.nextProperty.easing)[this.name]):a=this.value;return a};d.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},u=function(d,a){function c(a,c,d){"undefined"!==typeof d&&(a[c]=d,a.style[c]=d+"px");return a[c]}function g(a){a.config.clearOnUpdate&&
a.canvasClear()}function j(c){k(c,"beforeDraw",a);var d=c._drawOrder.length,g;c._drawOrderSorter?(g=a.sortBy(c._canvasActors,c._drawOrderSorter),g=a.pluck(g,"id")):g=c._drawOrder;var o,i,b;for(b=0;b<d;b++)o=c._canvasActors[g[b]],i=o.context(),o.draw(i,o.get());k(c,"afterDraw",a);return c}function m(a,c){c instanceof i.CanvasActor&&(a._drawOrder.push(c.id),a._canvasActors[c.id]=c)}function q(c,d){if(d instanceof i.CanvasActor)c._drawOrder=a.without(c._drawOrder,d.id),delete c._canvasActors[d.id]}var i=
d.Kapi;i.prototype._contextInitHook.canvas=function(){this._drawOrder=[];this._drawOrderSorter=null;this._canvasActors={};this.config.clearOnUpdate=!0;a.extend(this._events,{beforeDraw:[],afterDraw:[]});a.each(["Height","Width"],function(a){var c=a.toLowerCase();this.config[c]&&(this["canvas"+a](this.config[c]),delete this.config[a])},this);this.on("afterUpdate",j);this.on("addActor",m);this.on("removeActor",q);this.on("beforeDraw",g)};i.prototype.canvasHeight=function(a){return c(this.context,"height",
a)};i.prototype.canvasWidth=function(a){return c(this.context,"width",a)};i.prototype.canvasClear=function(){this.context.getContext&&this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};i.prototype.canvasContext=function(){return this.context.getContext("2d")};i.prototype.redraw=function(){j(this);return this};i.prototype.moveActorToLayer=function(c,d){if(d<this._drawOrder.length)return this._drawOrder=a.without(this._drawOrder,c.id),this._drawOrder.splice(d,0,
c.id),c};i.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};i.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};i.prototype.exportTimeline=function(){var c={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};a.each(this._drawOrder,function(a){c.actors[a]=this._actors[a].exportTimeline()},this);return c}},v=function(d){function a(){}var c=d.Kapi;a.prototype=c.Actor.prototype;d=c.CanvasActor=function(a){c.Actor.call(this,
a);a=a||{};this.draw=a.draw||t;return this};d.prototype=new a;d.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")};d.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)}},w=function(d,a){function c(){}var g=d.Kapi,j=["transform","webkitTransform","MozTransform","oTransform","msTransform"];g.DOMActor=function(a){g.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=
" "+a);delete this.update;delete this.teardown;return this};c.prototype=g.Actor.prototype;g.DOMActor.prototype=new c;c.prototype.update=function(c,d){a.each(d,function(d,g){"transform"===g?a.each(j,function(a){c.style[a]=d},this):c.style[g]=d},this)};c.prototype.teardown=function(){var c=this._context.className.match(/\S+/g);this._context.className=a.without(c,this.getCSSName())};c.prototype.getCSSName=function(){return"actor-"+this.id}},x=function(d,a){function c(c){var d=["{"],b;a.each(c.get(),
function(a,c){b=a;var e=c;"transform"===c&&(e=q);d.push(e+":"+b+";")});d.push("}");return d.join("")}function g(c,d,b){var b=b||["w3"],h=[];a.each(b,function(a){a=n(l,[i[a],d,c]).replace(RegExp(q,"g"),i[a]+"transform");h.push(a)});return h.join("\n")}function j(c,d,b){var d=d||["w3"],h=[],f;a.each(d,function(a){var d=[],a=i[a],g=c.getStart(),j=c.getEnd()-g,j=n("  %sanimation-duration: %sms;",[a,j]);d.push(j);j=n("  %sanimation-name: %s;",[a,b+"-keyframes"]);d.push(j);g=n("  %sanimation-delay: %sms;",
[a,g]);d.push(g);a=n("  %sanimation-fill-mode: forwards;",[a]);d.push(a);f=d.join("\n");h.push(f)});return n(p,[b,h.join("\n")])}var k=d.Kapi,q="TRANSFORM",i=k.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},l="@%skeyframes %s-keyframes {\n%s\n}",p=".%s {\n  position: absolute;\n%s\n}";d.Kapi.prototype.toCSS=function(c){var c=c||{},d=[],b=this.getActorIds();a.each(b,function(a){d.push(this.getActor(a).toCSS(c))},this);return d.join("\n")};d.Kapi.Actor.prototype.toCSS=
function(a){var a=a||{},d=[],b=a.name||this.getCSSName(),h=a.granularity||100,f=j(this,a.vendors,b);d.push(f);var f=this.getLength(),e=this.getStart(),i=[],k,h=f/h,m=f/100,l=e+h,n=f+e-h;this.updateState(e);for(i.push("  from "+c(this));l<=n;l+=h)this.updateState(l),k=(l-e)/m,k=+k.toFixed(2),k+="% ",i.push("  "+k+c(this));this.updateState(f+e);i.push("  to "+c(this));f=i.join("\n");a=g(f,b,a.vendors);d.push(a);return d.join("\n")};var n=k.util.printf=function(c,d){var b=c;a.each(d,function(a){b=b.replace("%s",
a)});return b}},y=function(d,a){var c=a?{}:d,g=a&&a.underscore?a.underscore:c._,j=a&&a.Tweenable?a.Tweenable:c.Tweenable;z(c,g,j);A(c,g,j);B(c,g,j);"function"===typeof w&&w(c,g,j);"function"===typeof x&&x(c,g,j);"function"===typeof u&&u(c,g,j);"function"===typeof v&&v(c,g,j);return c.Kapi};if("function"===typeof define&&define.amd){var C="undefined"!==typeof _;define(["shifty","underscore"],function(d,a){var c=null!==a,g={Tweenable:d,underscore:c?a:_},j=y(s,g);if("undefined"!==typeof KAPI_DEBUG&&
!0===KAPI_DEBUG)j.underscore_version=g.underscore.VERSION;if(!C&&c)s._=void 0;return j})}else y("undefined"!==typeof s?s:this)})(this);
