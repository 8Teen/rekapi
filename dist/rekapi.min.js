/**
 * Rekapi - Rewritten Kapi. v0.8.11
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(s){var y=function(f,a,d){function k(c,b){return Math.floor(b/c._animationLength)}function j(c){return e()-c._loopTimestamp}function m(c,b){return b>=c._timesToIterate&&-1!==c._timesToIterate}function i(c,b){m(c,b)&&(c.stop(),g(c,"onAnimationComplete"))}function o(c,b,e){return m(c,e)?c._animationLength:b%c._animationLength}function n(c){var b=j(c),e;e=k(c,b);b=o(c,b,e);c.render(b);i(c,e)}function q(c){var b=function(){q(c);n(c)};c._loopId=c._scheduleUpdate.call?c._scheduleUpdate.call(d,
b,1E3/c.config.fps):setTimeout(b,1E3/c.config.fps)}function g(c,e){b.each(c._events[e],function(b){b(c)})}function l(c){return 60!==c?d.setTimeout:d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame||d.mozCancelRequestAnimationFrame&&d.mozRequestAnimationFrame||d.setTimeout}function p(c){return 60!==c?d.clearTimeout:d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame||d.mozCancelRequestAnimationFrame||
d.clearTimeout}function h(c){c._cancelUpdate.call?c._cancelUpdate.call(d,c._loopId):clearTimeout(c._loopId)}var b=a&&a.underscore?a.underscore:f._,e=(a&&a.Tweenable?a.Tweenable:f.Tweenable).util.now,r={fps:60,clearOnUpdate:!0},a=f.Kapi||function(c){this.config=c||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[],onBeforeDraw:[]};
this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;b.extend(this.config,c);b.defaults(this.config,r);this._scheduleUpdate=l(this.config.fps);this._cancelUpdate=p(this.config.fps);b.each(this._contextInitHook,function(c){c.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var c=[];b.each(this._actors,function(b){c.push(b.getEnd())});this._animationLength=
Math.max.apply(Math,c);return this};a.prototype.addActor=function(c){if(!b.contains(this._actors,c))c.context()||c.context(this.context),c.kapi=this,c.fps=this.framerate(),this._actors[c.id]=c,this._drawOrder.push(c.id),c.setup();return this};a.prototype.getActor=function(c){return this._actors[c]};a.prototype.getActorIds=function(){return b.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return b.clone(this._actors)};a.prototype.removeActor=function(c){delete this._actors[c.id];delete c.kapi;
this._drawOrder=b.without(this._drawOrder,c.id);c.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(c){h(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(e()-this._pausedAtTime):e();this._timesToIterate=c||-1;this._playState="playing";q(this);b.each(this._actors,function(c){c._state.isPaused&&c.resume()});g(this,"onPlayStateChange");g(this,"onPlay");return this};a.prototype.playFrom=function(c,b){this.play(b);this._loopTimestamp=e()-c;return this};
a.prototype.playFromCurrent=function(c){return this.playFrom(this._lastRenderedMillisecond,c)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";h(this);this._pausedAtTime=e();b.each(this._actors,function(c){c._state.isTweening&&c.pause()});g(this,"onPlayStateChange");g(this,"onPause");return this};a.prototype.stop=function(){this._playState="stopped";h(this);b.each(this._actors,function(c){c.stop()});g(this,"onPlayStateChange");g(this,"onStop");return this};
a.prototype.isPlaying=function(){return"playing"===this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(c){if(c)this.config.fps=c,this._scheduleUpdate=l(this.config.fps),this._cancelUpdate=p(this.config.fps);return this.config.fps};a.prototype.render=function(c){this.calculateActorPositions(c);
var e,a,r,d,i;g(this,"onBeforeDraw");a=this._drawOrder.length;this._drawOrderSorter?(e=b.sortBy(this._actors,this._drawOrderSorter),i=b.pluck(e,"id")):i=this._drawOrder;for(e=0;e<a;e++)r=this._actors[i[e]],d=r.context(),r.render(d,r.get());this._lastRenderedMillisecond=c;g(this,"onFrameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(c){for(var b=this._drawOrder.length,e=0;e<b;e++)this._actors[this._drawOrder[e]].calculatePosition(c);
return this};a.prototype.moveActorToLayer=function(c,e){if(e<this._drawOrder.length)return this._drawOrder=b.without(this._drawOrder,c.id),this._drawOrder.splice(e,0,c.id),c};a.prototype.bind=function(c,b){if(this._events[c])return this._events[c].push(b),this};a.prototype.unbind=function(c,e){if(this._events[c])return this._events[c]=e?b.without(this._events[c],e):[],this};a.prototype.setOrderFunction=function(c){this._drawOrderSorter=c;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=
null;return this};a.prototype.exportTimeline=function(){var c={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};b.each(this._drawOrder,function(b){c.actors[b]=this._actors[b].exportTimeline()},this);return c};a.util={};b.extend(a.util,{noop:function(){},calculateLoopPosition:o,calculateTimeSinceStart:j});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={calculateLoopPosition:o,renderCurrentMillisecond:n,tick:q,determineCurrentLoopIteration:k,calculateTimeSinceStart:j,
isAnimationComplete:m,updatePlayState:i};f.Kapi=a},z=function(f,a){function d(b){return b.sort(function(b,a){return b-a})}function k(b,e){for(var a=b._timelinePropertyCacheIndex,c=a.length,d=1;d<c;d++)if(a[d]>=e)return d-1;return-1}function j(b){g.each(b._propertyTracks,function(e,a){b._propertyTracks[a]=g.sortBy(b._propertyTracks[a],function(b){return b.millisecond})})}function m(b){g.each(b._timelinePropertyCaches,function(e,a){var c=i(b,+a);g.defaults(e,c)})}function i(b,e){var a={};g.each(b._propertyTracks,
function(b,d){var i=null;g.find(b,function(b){b.millisecond>e?a[d]=i:b.millisecond===e&&(a[d]=b);i=b;return!!a[d]});if(!a[d]){var h=g.last(b);h&&h.millisecond<=e&&(a[d]=h)}});return a}function o(b){g.each(b._propertyTracks,function(b){g.each(b,function(a,c){a.linkToNext(b[c+1])})})}function n(b,e,a){return g.find(b._propertyTracks[e],function(b){return b.millisecond===a})}var q=0,g=a&&a.underscore?a.underscore:f._,l=a&&a.Tweenable?a.Tweenable:f.Tweenable,p=f.Kapi,h=p.Actor=function(b){b=b||{};this.constructor.call(this);
g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isPersisting:!1,id:q++,setup:b.setup||p.util.noop,render:b.render||p.util.noop,teardown:b.teardown||p.util.noop});b.context&&this.context(opt_context);return this};ActorMethods=function(){};ActorMethods.prototype=l.prototype;h.prototype=new ActorMethods;h.prototype.context=function(b){if(b)this._context=b;return this._context};h.prototype.keyframe=function(b,e,a){var c,a=a||
"linear";"string"===typeof a&&(c=a,a={},g.each(e,function(b,e){a[e]=c}));g.each(e,function(b,c){a[c]=a[c]||"linear"});g.each(e,function(c,e){var d;d=new p.KeyframeProperty(this,b,e,c,a[e]);this._keyframeProperties[d.id]=d;this._propertyTracks[e]||(this._propertyTracks[e]=[]);this._propertyTracks[e].push(d);j(this)},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.getKeyframeProperty=function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};
h.prototype.modifyKeyframeProperty=function(b,a,d){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(d);j(this);this.invalidatePropertyCache();return this};h.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};h.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};h.prototype.copyProperties=function(b,a){var d,c;d={};c={};g.each(this._propertyTracks,function(b,i){var h;if(h=n(this,i,
a))d[i]=h.value,c[i]=h.easing},this);this.keyframe(b,d,c);return this};h.prototype.wait=function(b){var a=this.getEnd();if(b<=a)return this;var a=this.getEnd(),d=i(this,this.getEnd()),c={},h={};g.each(d,function(b,a){c[a]=b.value;h[a]=b.easing});this.removeKeyframe(a);this.keyframe(a,c,h);this.keyframe(b,c,h);return this};h.prototype.getStart=function(){var b=[];g.each(this._propertyTracks,function(a){a.length&&b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};h.prototype.getEnd=
function(){var b=0;g.each(this._propertyTracks,function(a){if(a.length)a=g.last(a).millisecond,a>b&&(b=a)},this);return b};h.prototype.getLength=function(){return this.getEnd()-this.getStart()};h.prototype.modifyKeyframe=function(b,a,d){d=d||{};g.each(this._propertyTracks,function(c,i){var h=n(this,i,b);h&&h.modifyWith({value:a[i],easing:d[i]})},this);return this};h.prototype.removeKeyframe=function(b){g.each(this._propertyTracks,function(a){var d=-1,c=!1;g.find(a,function(a){d++;return c=b===a.millisecond});
c&&(a=a.splice(d,1)[0])&&delete this._keyframeProperties[a.id]},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.removeAllKeyframeProperties=function(){g.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};h.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,b)};h.prototype.calculatePosition=function(b){var a=this.getStart(),d=this.getEnd();if(a<=b&&b<=d){var a=
this._timelinePropertyCaches[this._timelinePropertyCacheIndex[k(this,b)]],c={};g.each(a,function(a,d){a&&(c[d]=a.getValueAt(b))});this.set(c)}return this};h.prototype.data=function(b){if(b)this._data=b;return this._data};h.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(a,d){var c=b.propertyTracks[d]=[];g.each(a,function(b){c.push(b.exportPropertyData())})});return b};h.prototype.invalidatePropertyCache=
function(){this._timelinePropertyCaches={};g.each(this._keyframeProperties,function(b){this._timelinePropertyCaches[b.millisecond]||(this._timelinePropertyCaches[b.millisecond]={});this._timelinePropertyCaches[b.millisecond][b.name]=b},this);this._timelinePropertyCacheIndex=g.keys(this._timelinePropertyCaches);g.each(this._timelinePropertyCacheIndex,function(b,a){this._timelinePropertyCacheIndex[a]=+b},this);d(this._timelinePropertyCacheIndex);m(this);o(this)}},A=function(f,a){var d=a&&a.underscore?
a.underscore:f._,k=a&&a.Tweenable?a.Tweenable:f.Tweenable,j=f.Kapi.KeyframeProperty=function(a,i,f,k,j){this.id=d.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=i;this.name=f;this.value=k;this.easing=j||"linear";this.nextProperty=null;return this};j.prototype.modifyWith=function(a){var i={};d.each(["millisecond","easing","value"],function(d){i[d]="undefined"===typeof a[d]?this[d]:a[d]},this);d.extend(this,i)};j.prototype.linkToNext=function(a){this.nextProperty=a||null};j.prototype.getValueAt=
function(a){var d,f,j;d={};f={};this.nextProperty?(d[this.name]=this.value,f[this.name]=this.nextProperty.value,j=this.nextProperty.millisecond-this.millisecond,a=(a-this.millisecond)/j,d=k.util.interpolate(d,f,a,this.nextProperty.easing)[this.name]):d=this.value;return d};j.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},t=function(f,a){function d(a,d,f){"undefined"!==typeof f&&(a[d]=f,a.style[d]=f+"px");
return a[d]}function k(){this.config.clearOnUpdate&&this.canvasClear()}var j=f.Kapi,m=a&&a.underscore?a.underscore:f._;j.prototype._contextInitHook.canvas=function(){this.config.context&&"CANVAS"===this.config.context.nodeName&&(m.each(["Height","Width"],function(a){var d=a.toLowerCase();this.config[d]&&(this["canvas"+a](this.config[d]),delete this.config[a])},this),this.bind("onBeforeDraw",m.bind(k,this)))};j.prototype.canvasHeight=function(a){return d(this.context,"height",a)};j.prototype.canvasWidth=
function(a){return d(this.context,"width",a)};j.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};j.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(f){function a(){}var d=f.Kapi;a.prototype=d.Actor.prototype;f=d.CanvasActor=function(a){d.Actor.call(this,a);return this};f.prototype=new a;f.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},
v=function(f,a){function d(){}var k=f.Kapi,j=a&&a.underscore?a.underscore:f._,m=["transform","webkitTransform","MozTransform","oTransform","msTransform"];k.DOMActor=function(a){k.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=" "+a);delete this.render;delete this.teardown;return this};d.prototype=k.Actor.prototype;k.DOMActor.prototype=new d;d.prototype.render=function(a,d){j.each(d,function(d,f){"transform"===f?j.each(m,function(f){a.style[f]=
d},this):a.style[f]=d},this)};d.prototype.teardown=function(){var a=this._context.className.match(/\S+/g);this._context.className=j.without(a,this.getCSSName())};d.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(f,a){function d(a){var d=["{"],b;i.each(a.get(),function(a,f){b=a;var c=f;"transform"===f&&(c=o);d.push(c+":"+b+";")});d.push("}");return d.join("")}function k(a,d,b){var b=b||["w3"],e=[];i.each(b,function(b){b=l(q,[n[b],d,a]).replace(RegExp(o,"g"),n[b]+"transform");e.push(b)});
return e.join("\n")}function j(a,d){var d=d||["w3"],b=[],e;i.each(d,function(d){var c=[],d=n[d],f=a.getStart(),h=a.getEnd()-f,h=l("  %sanimation-duration: %sms;",[d,h]);c.push(h);h=l("  %sanimation-name: %s;",[d,a.getCSSName()+"-keyframes"]);c.push(h);f=l("  %sanimation-delay: %sms;",[d,f]);c.push(f);d=l("  %sanimation-fill-mode: forwards;",[d]);c.push(d);e=c.join("\n");b.push(e)});return l(g,[a.getCSSName(),b.join("\n")])}var m=f.Kapi,i=a&&a.underscore?a.underscore:f._,o="TRANSFORM",n=m.util.VENDOR_PREFIXES=
{microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},q="@%skeyframes %s-keyframes {\n%s\n}",g=".%s {\n  position: absolute;\n%s\n}";f.Kapi.prototype.toCSS=function(a){var a=a||{},d=[],b=this.getActorIds();i.each(b,function(b){d.push(this.getActor(b).toCSS(a))},this);return d.join("\n")};f.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},f=[],b=a.granularity||100,e=j(this,a.vendors);f.push(e);var e=this.getLength(),g=this.getStart(),c=[],i,b=e/b,m=e/100,l=g+b,n=e+g-b;this.calculatePosition(g);
for(c.push("  from "+d(this));l<=n;l+=b)this.calculatePosition(l),i=(l-g)/m,i=+i.toFixed(2),i+="% ",c.push("  "+i+d(this));this.calculatePosition(e+g);c.push("  to "+d(this));e=c.join("\n");a=k(e,this.getCSSName(),a.vendors);f.push(a);return f.join("\n")};var l=m.util.printf=function(a,d){var b=a;i.each(d,function(a){b=b.replace("%s",a)});return b}},x=function(f,a){var d=a?{}:f;y(d,a,f);z(d,a);A(d,a);"function"===typeof v&&v(d,a);"function"===typeof w&&w(d,a);"function"===typeof t&&t(d,a);"function"===
typeof u&&u(d,a);return d.Kapi};if("function"===typeof define&&define.amd){var B="undefined"!==typeof _;define(["shifty","underscore"],function(f,a){var d={Tweenable:f,underscore:null!==a?a:_},k=x(s,d);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)k.underscore_version=d.underscore.VERSION;if(!B)s._=void 0;return k})}else x("undefined"!==typeof s?s:this)})(this);
