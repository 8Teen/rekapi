/**
 * Rekapi - Rewritten Kapi. v0.8.13
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(s){var y=function(e,a,d){function k(c,b){return Math.floor(b/c._animationLength)}function j(c){return f()-c._loopTimestamp}function m(c,b){return b>=c._timesToIterate&&-1!==c._timesToIterate}function i(c,b){m(c,b)&&(c.stop(),g(c,"onAnimationComplete"))}function o(c,b,f){return m(c,f)?c._animationLength:b%c._animationLength}function n(c){var b=j(c),f=k(c,b),b=o(c,b,f);c.render(b);i(c,f)}function q(c){var b=function(){q(c);n(c)};c._loopId=c._scheduleUpdate.call?c._scheduleUpdate.call(d,b,
1E3/c.config.fps):setTimeout(b,1E3/c.config.fps)}function g(c,f){b.each(c._events[f],function(b){b(c)})}function l(c){return 60!==c?d.setTimeout:d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame||d.mozCancelRequestAnimationFrame&&d.mozRequestAnimationFrame||d.setTimeout}function p(c){return 60!==c?d.clearTimeout:d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame||d.mozCancelRequestAnimationFrame||
d.clearTimeout}function h(c){c._cancelUpdate.call?c._cancelUpdate.call(d,c._loopId):clearTimeout(c._loopId)}var b=a&&a.underscore?a.underscore:e._,f=(a&&a.Tweenable?a.Tweenable:e.Tweenable).util.now,r={fps:60},a=e.Kapi||function(c){this.config=c||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[],onBeforeDraw:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;b.extend(this.config,c);b.defaults(this.config,r);this._scheduleUpdate=l(this.config.fps);this._cancelUpdate=p(this.config.fps);b.each(this._contextInitHook,function(c){c.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var c=[];b.each(this._actors,function(b){c.push(b.getEnd())});this._animationLength=Math.max.apply(Math,
c);return this};a.prototype.addActor=function(c){if(!b.contains(this._actors,c))c.context()||c.context(this.context),c.kapi=this,c.fps=this.framerate(),this._actors[c.id]=c,this._drawOrder.push(c.id),c.setup();return this};a.prototype.getActor=function(c){return this._actors[c]};a.prototype.getActorIds=function(){return b.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return b.clone(this._actors)};a.prototype.removeActor=function(c){delete this._actors[c.id];delete c.kapi;this._drawOrder=
b.without(this._drawOrder,c.id);c.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(c){h(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(f()-this._pausedAtTime):f();this._timesToIterate=c||-1;this._playState="playing";q(this);b.each(this._actors,function(c){c._state.isPaused&&c.resume()});g(this,"onPlayStateChange");g(this,"onPlay");return this};a.prototype.playFrom=function(c,b){this.play(b);this._loopTimestamp=f()-c;return this};a.prototype.playFromCurrent=
function(c){return this.playFrom(this._lastRenderedMillisecond,c)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";h(this);this._pausedAtTime=f();b.each(this._actors,function(c){c._state.isTweening&&c.pause()});g(this,"onPlayStateChange");g(this,"onPause");return this};a.prototype.stop=function(){this._playState="stopped";h(this);b.each(this._actors,function(c){c.stop()});g(this,"onPlayStateChange");g(this,"onStop");return this};a.prototype.isPlaying=
function(){return"playing"===this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(c){if(c)this.config.fps=c,this._scheduleUpdate=l(this.config.fps),this._cancelUpdate=p(this.config.fps);return this.config.fps};a.prototype.render=function(c){this.calculateActorPositions(c);
g(this,"onBeforeDraw");var f=this._drawOrder.length,a;this._drawOrderSorter?(a=b.sortBy(this._actors,this._drawOrderSorter),a=b.pluck(a,"id")):a=this._drawOrder;for(var r,d,h=0;h<f;h++)r=this._actors[a[h]],d=r.context(),r.render(d,r.get());this._lastRenderedMillisecond=c;g(this,"onFrameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(c){for(var b=this._drawOrder.length,f=0;f<b;f++)this._actors[this._drawOrder[f]].calculatePosition(c);
return this};a.prototype.moveActorToLayer=function(c,f){if(f<this._drawOrder.length)return this._drawOrder=b.without(this._drawOrder,c.id),this._drawOrder.splice(f,0,c.id),c};a.prototype.bind=function(c,b){if(this._events[c])return this._events[c].push(b),this};a.prototype.unbind=function(c,f){if(this._events[c])return this._events[c]=f?b.without(this._events[c],f):[],this};a.prototype.setOrderFunction=function(c){this._drawOrderSorter=c;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=
null;return this};a.prototype.exportTimeline=function(){var c={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};b.each(this._drawOrder,function(b){c.actors[b]=this._actors[b].exportTimeline()},this);return c};a.util={};b.extend(a.util,{noop:function(){},calculateLoopPosition:o,calculateTimeSinceStart:j});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={calculateLoopPosition:o,renderCurrentMillisecond:n,tick:q,determineCurrentLoopIteration:k,calculateTimeSinceStart:j,
isAnimationComplete:m,updatePlayState:i};e.Kapi=a},z=function(e,a){function d(b){return b.sort(function(b,a){return b-a})}function k(b,f){for(var a=b._timelinePropertyCacheIndex,c=a.length,d=1;d<c;d++)if(a[d]>=f)return d-1;return-1}function j(b){g.each(b._propertyTracks,function(f,a){b._propertyTracks[a]=g.sortBy(b._propertyTracks[a],function(b){return b.millisecond})})}function m(b){g.each(b._timelinePropertyCaches,function(f,a){var c=i(b,+a);g.defaults(f,c)})}function i(b,f){var a={};g.each(b._propertyTracks,
function(b,d){var h=null;g.find(b,function(b){b.millisecond>f?a[d]=h:b.millisecond===f&&(a[d]=b);h=b;return!!a[d]});if(!a[d]){var i=g.last(b);i&&i.millisecond<=f&&(a[d]=i)}});return a}function o(b){g.each(b._propertyTracks,function(b){g.each(b,function(a,c){a.linkToNext(b[c+1])})})}function n(b,a,d){return g.find(b._propertyTracks[a],function(b){return b.millisecond===d})}var q=0,g=a&&a.underscore?a.underscore:e._,l=a&&a.Tweenable?a.Tweenable:e.Tweenable,p=e.Kapi,h=p.Actor=function(b){b=b||{};this.constructor.call(this);
g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:q++,setup:b.setup||p.util.noop,render:b.render||p.util.noop,teardown:b.teardown||p.util.noop});b.context&&this.context(opt_context);return this};ActorMethods=function(){};ActorMethods.prototype=l.prototype;h.prototype=new ActorMethods;h.prototype.context=function(b){if(b)this._context=b;return this._context};h.prototype.keyframe=function(b,a,d){var c,d=d||"linear";"string"===
typeof d&&(c=d,d={},g.each(a,function(b,a){d[a]=c}));g.each(a,function(b,c){d[c]=d[c]||"linear"});g.each(a,function(c,a){var f=new p.KeyframeProperty(this,b,a,c,d[a]);this._keyframeProperties[f.id]=f;this._propertyTracks[a]||(this._propertyTracks[a]=[]);this._propertyTracks[a].push(f);j(this)},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.getKeyframeProperty=function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};
h.prototype.modifyKeyframeProperty=function(b,a,d){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(d);j(this);this.invalidatePropertyCache();return this};h.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};h.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};h.prototype.copyProperties=function(b,a){var d={},c={};g.each(this._propertyTracks,function(b,h){var i=n(this,h,a);if(i)d[h]=
i.value,c[h]=i.easing},this);this.keyframe(b,d,c);return this};h.prototype.wait=function(b){var a=this.getEnd();if(b<=a)return this;var a=this.getEnd(),d=i(this,this.getEnd()),c={},h={};g.each(d,function(b,a){c[a]=b.value;h[a]=b.easing});this.removeKeyframe(a);this.keyframe(a,c,h);this.keyframe(b,c,h);return this};h.prototype.getStart=function(){var b=[];g.each(this._propertyTracks,function(a){a.length&&b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};h.prototype.getEnd=
function(){var b=0;g.each(this._propertyTracks,function(a){if(a.length)a=g.last(a).millisecond,a>b&&(b=a)},this);return b};h.prototype.getLength=function(){return this.getEnd()-this.getStart()};h.prototype.modifyKeyframe=function(b,a,d){d=d||{};g.each(this._propertyTracks,function(c,h){var i=n(this,h,b);i&&i.modifyWith({value:a[h],easing:d[h]})},this);return this};h.prototype.removeKeyframe=function(b){g.each(this._propertyTracks,function(a){var d=-1,c=!1;g.find(a,function(a){d++;return c=b===a.millisecond});
c&&(a=a.splice(d,1)[0])&&delete this._keyframeProperties[a.id]},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.removeAllKeyframeProperties=function(){g.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};h.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,b)};h.prototype.calculatePosition=function(b){var a=this.getStart(),d=this.getEnd();if(a<=b&&b<=d){var a=
this._timelinePropertyCaches[this._timelinePropertyCacheIndex[k(this,b)]],c={};g.each(a,function(a,d){a&&(c[d]=a.getValueAt(b))});this.set(c)}return this};h.prototype.data=function(b){if(b)this._data=b;return this._data};h.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(a,d){var c=b.propertyTracks[d]=[];g.each(a,function(b){c.push(b.exportPropertyData())})});return b};h.prototype.invalidatePropertyCache=
function(){this._timelinePropertyCaches={};g.each(this._keyframeProperties,function(b){this._timelinePropertyCaches[b.millisecond]||(this._timelinePropertyCaches[b.millisecond]={});this._timelinePropertyCaches[b.millisecond][b.name]=b},this);this._timelinePropertyCacheIndex=g.keys(this._timelinePropertyCaches);g.each(this._timelinePropertyCacheIndex,function(b,a){this._timelinePropertyCacheIndex[a]=+b},this);d(this._timelinePropertyCacheIndex);m(this);o(this)}},A=function(e,a){var d=a&&a.underscore?
a.underscore:e._,k=a&&a.Tweenable?a.Tweenable:e.Tweenable,j=e.Kapi.KeyframeProperty=function(a,i,e,k,j){this.id=d.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=i;this.name=e;this.value=k;this.easing=j||"linear";this.nextProperty=null;return this};j.prototype.modifyWith=function(a){var i={};d.each(["millisecond","easing","value"],function(d){i[d]="undefined"===typeof a[d]?this[d]:a[d]},this);d.extend(this,i)};j.prototype.linkToNext=function(a){this.nextProperty=a||null};j.prototype.getValueAt=
function(a){var d={},e={};this.nextProperty?(d[this.name]=this.value,e[this.name]=this.nextProperty.value,a=k.util.interpolate(d,e,(a-this.millisecond)/(this.nextProperty.millisecond-this.millisecond),this.nextProperty.easing)[this.name]):a=this.value;return a};j.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},t=function(e,a){function d(a,d,e){"undefined"!==typeof e&&(a[d]=e,a.style[d]=e+"px");return a[d]}
function k(){this.config.clearOnUpdate&&this.canvasClear()}var j=e.Kapi,m=a&&a.underscore?a.underscore:e._;j.prototype._contextInitHook.canvas=function(){if(this.config.context&&"CANVAS"===this.config.context.nodeName)this.config.clearOnUpdate=!0,m.each(["Height","Width"],function(a){var d=a.toLowerCase();this.config[d]&&(this["canvas"+a](this.config[d]),delete this.config[a])},this),this.bind("onBeforeDraw",m.bind(k,this))};j.prototype.canvasHeight=function(a){return d(this.context,"height",a)};
j.prototype.canvasWidth=function(a){return d(this.context,"width",a)};j.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};j.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(e){function a(){}var d=e.Kapi;a.prototype=d.Actor.prototype;e=d.CanvasActor=function(a){d.Actor.call(this,a);return this};e.prototype=new a;e.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},
v=function(e,a){function d(){}var k=e.Kapi,j=a&&a.underscore?a.underscore:e._,m=["transform","webkitTransform","MozTransform","oTransform","msTransform"];k.DOMActor=function(a){k.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=" "+a);delete this.render;delete this.teardown;return this};d.prototype=k.Actor.prototype;k.DOMActor.prototype=new d;d.prototype.render=function(a,d){j.each(d,function(d,e){"transform"===e?j.each(m,function(e){a.style[e]=
d},this):a.style[e]=d},this)};d.prototype.teardown=function(){var a=this._context.className.match(/\S+/g);this._context.className=j.without(a,this.getCSSName())};d.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(e,a){function d(a){var d=["{"],b;i.each(a.get(),function(a,e){b=a;var c=e;"transform"===e&&(c=o);d.push(c+":"+b+";")});d.push("}");return d.join("")}function k(a,d,b){var b=b||["w3"],f=[];i.each(b,function(b){b=l(q,[n[b],d,a]).replace(RegExp(o,"g"),n[b]+"transform");f.push(b)});
return f.join("\n")}function j(a,d){var d=d||["w3"],b=[],f;i.each(d,function(d){var c=[],d=n[d],h=a.getStart(),e=a.getEnd()-h,e=l("  %sanimation-duration: %sms;",[d,e]);c.push(e);e=l("  %sanimation-name: %s;",[d,a.getCSSName()+"-keyframes"]);c.push(e);h=l("  %sanimation-delay: %sms;",[d,h]);c.push(h);d=l("  %sanimation-fill-mode: forwards;",[d]);c.push(d);f=c.join("\n");b.push(f)});return l(g,[a.getCSSName(),b.join("\n")])}var m=e.Kapi,i=a&&a.underscore?a.underscore:e._,o="TRANSFORM",n=m.util.VENDOR_PREFIXES=
{microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},q="@%skeyframes %s-keyframes {\n%s\n}",g=".%s {\n  position: absolute;\n%s\n}";e.Kapi.prototype.toCSS=function(a){var a=a||{},d=[],b=this.getActorIds();i.each(b,function(b){d.push(this.getActor(b).toCSS(a))},this);return d.join("\n")};e.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},e=[],b=a.granularity||100,f=j(this,a.vendors);e.push(f);var f=this.getLength(),g=this.getStart(),c=[],i,b=f/b,m=f/100,l=g+b,n=f+g-b;this.calculatePosition(g);
for(c.push("  from "+d(this));l<=n;l+=b)this.calculatePosition(l),i=(l-g)/m,i=+i.toFixed(2),i+="% ",c.push("  "+i+d(this));this.calculatePosition(f+g);c.push("  to "+d(this));f=c.join("\n");a=k(f,this.getCSSName(),a.vendors);e.push(a);return e.join("\n")};var l=m.util.printf=function(a,d){var b=a;i.each(d,function(a){b=b.replace("%s",a)});return b}},x=function(e,a){var d=a?{}:e;y(d,a,e);z(d,a);A(d,a);"function"===typeof v&&v(d,a);"function"===typeof w&&w(d,a);"function"===typeof t&&t(d,a);"function"===
typeof u&&u(d,a);return d.Kapi};if("function"===typeof define&&define.amd){var B="undefined"!==typeof _;define(["shifty","underscore"],function(e,a){var d={Tweenable:e,underscore:null!==a?a:_},k=x(s,d);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)k.underscore_version=d.underscore.VERSION;if(!B)s._=void 0;return k})}else x("undefined"!==typeof s?s:this)})(this);
