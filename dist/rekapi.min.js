/**
 * Rekapi - Rewritten Kapi. v0.2.1
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(d){function i(b){return b.sort(function(b,a){return b-a})}function c(b,a){return Math.floor(a/b._animationLength)}function g(b){return k()-b._loopTimestamp}function a(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function j(b,c){a(b,c)&&(b.stop(),h(b,"onAnimationComplete"))}function e(b,c,j){return a(b,j)?b._animationLength:c%b._animationLength}function m(b){var a=g(b),f;f=c(b,a);a=e(b,a,f);j(b,f);b.render(a)}function l(b){b._loopId=setTimeout(function(){l(b);m(b)},1E3/b.config.fps)}
function h(b,a){_.each(b._events[a],function(a){a(b)})}if(!_)throw"underscore.js is required for Kapi.";if(!Tweenable)throw"shifty.js is required for Kapi.";var f,n,k;n={fps:30,height:150,width:300};k=Tweenable.util.now;f=d.Kapi||function(b,a){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._events={onFrameRender:[],onStart:[],onAnimationComplete:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=
this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,a);_.defaults(this.config,n);_.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};f.prototype.addActor=function(b,a){if(!_.contains(this._actors,b))b.kapi=this,b.fps=this.framerate(),b.set(a||{}),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};f.prototype.getActor=function(b){return this._actors[b]};f.prototype.removeActor=
function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=_.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};f.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(k()-this._pausedAtTime):k();this._timesToIterate=b||-1;this._playState="playing";l(this);_.each(this._actors,function(b){b._state.isPaused&&b.resume()});h(this,"onPlay");return this};f.prototype.playFrom=function(b,a){this.play(a);
this._loopTimestamp=k()-b;return this};f.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};f.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=k();_.each(this._actors,function(b){b._state.isTweening&&b.pause()});return this};f.prototype.stop=function(b){this._playState="stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();_.each(this._actors,function(a){a.stop();
!0===b&&a.hide()});return this};f.prototype.isPlaying=function(){return"playing"===this._playState};f.prototype.animationLength=function(){return this._animationLength};f.prototype.actorCount=function(){return this._drawOrder.length};f.prototype.framerate=function(b){if(b)this.config.fps=b;return this.config.fps};f.prototype.render=function(b){this.calculateActorPositions(b);this.draw();this._lastRenderedMillisecond=b;h(this,"onFrameRender");return this};f.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);
return this};f.prototype.calculateActorPositions=function(b){var a,c;c=this._drawOrder.length;for(a=0;a<c;a++)this._actors[this._drawOrder[a]].calculatePosition(b);return this};f.prototype.draw=function(){var b,a,c,j;this.canvas_clear();a=this._drawOrder.length;j=this.canvas_getContext();for(b=0;b<a;b++)c=this._actors[this._drawOrder[b]],c.isShowing()&&c.draw(j,c.get());return this};f.prototype.updateInternalState=function(){var b;b=[0];_.each(this._drawOrder,function(a){b=b.concat(b,this._actors[a].keyframeList());
b=_.uniq(b)},this);this._animationLength=Math.max.apply(Math,b);return this};f.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};f.prototype.bind=function(b,a){if(this._events[b])return this._events[b].push(a),this};f.prototype.unbind=function(a,c){if(this._events[a])return this._events[a]=c?_.without(this._events[a],c):[],this};f.util={};_.extend(f.util,{noop:function(){},sortNumerically:i});
if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)f._private={sortNumerically:i,calculateLoopPosition:e,renderCurrentMillisecond:m,tick:l,determineCurrentLoopIteration:c,calculateTimeSinceStart:g,isAnimationComplete:a,updatePlayState:j};d.Kapi=f})(this);
(function(d){function i(a,c){_.each(c,function(c,j){void 0===c||null===c?delete a[j]:a[j]=c})}var c,g;c=d.Kapi;g=0;c.Actor=function(a){a=a||{};this.constructor.call(this);_.extend(this,{_keyframes:{},_keyframeList:[],_data:{},_isShowing:!1,_isPersisting:!1,id:g++,setup:a.setup||c.util.noop,draw:a.draw||c.util.noop,teardown:a.teardown||c.util.noop});return this};d=function(){};d.prototype=Tweenable.prototype;c.Actor.prototype=new d;c.Actor.prototype.keyframe=function(a,j,e){var g;e||(e="linear");"string"===
typeof e&&(g=e,e={},_.each(j,function(a,c){e[c]=g}));_.each(j,function(a,c){e[c]=e[c]||"linear"});this._keyframes[a]={position:j,easing:e};this._keyframeList.push(a);c.util.sortNumerically(this._keyframeList);this.kapi.updateInternalState();return this};c.Actor.prototype.liveCopy=function(a,c){var e;"undefined"===typeof c&&(c=_.last(this._keyframeList));this._keyframes.hasOwnProperty(c)&&(e=this._keyframes[c],this.keyframe(a,e.position,e.easing));return this};c.Actor.prototype.modifyKeyframe=function(a,
c,e){a=this._keyframes[a];i(a.position,c);e&&i(a.easing,e);return this};c.Actor.prototype.removeKeyframe=function(a){if(-1!==this._keyframeList.indexOf(a))this._keyframeList=_.without(this._keyframeList,a),delete this._keyframes[a],this.kapi.updateInternalState();return this};c.Actor.prototype.removeAllKeyframes=function(){var a;a=this._keyframeList.slice(0);_.each(a,function(a){this.removeKeyframe(a)},this);return this};c.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,
a)};c.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};c.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};c.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};c.Actor.prototype.calculatePosition=function(a){var c,e,g,d,h;e=this._keyframeList;g=_.first(e);h=_.last(e);this.hide();if(g<=a&&a<=h){this.show();g=this._keyframes;a:{d=this._keyframeList;c=d.length;for(h=1;h<c;h++)if(d[h]>=
a){h-=1;break a}h=-1}c=e[h];d=e[h+1];d=(a-c)/(d-c);var f,i,k;f=this._keyframeList;i=this._keyframes;a={};c={};for(k=h;0<=k;k--)_.defaults(a,i[f[k]].position),_.defaults(c,i[f[k]].easing);e=_.extend({},g[e[h+1]]);_.defaults(e.position,a);_.defaults(e.easing,c);this.set(a).interpolate(e.position,d,e.easing)}return this};c.Actor.prototype.keyframeList=function(){return this._keyframeList};c.Actor.prototype.data=function(a){if(a)this._data=a;return this._data};_.each(["tween","to"],function(a){c.Actor.prototype[a]=
function(){this.show(!0);Tweenable.prototype[a].apply(this,arguments)}},this)})(this);
(function(d){var i,c;i=d.Kapi;c=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(d.getComputedStyle)i.DOMActor=function(g){var a;a=new i.Actor({setup:function(){var a=this.kapi.canvas_getContext();"static"===d.getComputedStyle(a).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position="relative");"static"===d.getComputedStyle(g).getPropertyValue("position")&&(g.style.position="absolute")},draw:function(a,e){var d;d=!1;_.each(e,function(a,e){d=!0;"rotate"===
e?_.each(c,function(c){g.style[c]="rotate("+a+"deg)"}):g.style[e]=a});g.style.display=d?"block":"none"}});a.show=function(a){i.Actor.prototype.show.call(this,a);g.style.display="block"};a.hide=function(a){i.Actor.prototype.hide.call(this,a);g.style.display="none"};return a}})(this);
(function(d){function i(c,g,a,d){if("undefined"!==typeof d){c[a]=d;if(!c.style)c.style={};c.style[a]=d+"px"}return g===g.HTML_ELEMENT?c.style[a]:c[a]}d=d.Kapi;d.prototype.canvas_setContext=function(c){var d;this._canvas=c;d=c.nodeName;void 0===d?(this._context={},this._contextType="other"):"CANVAS"===d?(this._context=c.getContext("2d"),this._contextType="canvas"):(this._context=c,this._contextType="HTMLElement");return this.canvas_getContext()};d.prototype.canvas_getContext=function(){return this._context};
d.prototype.canvas_height=function(c){return i(this.canvas,this._contextType,"height",c)};d.prototype.canvas_width=function(c){return i(this.canvas,this._contextType,"width",c)};d.prototype.canvas_style=function(c,d){"undefined"!==typeof d&&this.canvas.style&&(this.canvas.style[c]=d);return this.canvas.style[c]};d.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}})(this);
(function(d){function i(c,g,a,j){var e=/^(__r__|__g__|__b__)/,i;i={};_.each(c,function(l,h){var f;f=h.match(e)?Tweenable.prototype.formula[j[h.slice(5)]]:Tweenable.prototype.formula[j[h]];"undefined"!==typeof g[h]&&(i[h]=d.Tweenable.util.tweenProp(c[h],g[h],f,a))});return i}d.Kapi.Actor.prototype.interpolate=function(c,g,a){var j=this.get(),e;e=d.Tweenable.util.simpleCopy({},j);d.Tweenable.util.applyFilter("tweenCreated",e,[e,j,c]);d.Tweenable.util.applyFilter("beforeTween",e,[e,j,c]);g=i(j,c,g,a);
d.Tweenable.util.applyFilter("afterTween",g,[g,j,c]);this.set(g);return g}})(this);
