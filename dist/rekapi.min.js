/**
 * Rekapi - Rewritten Kapi. v0.1.5
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(g){function d(a){return a.sort(function(a,b){return a-b})}function i(a,b){return Math.floor(b/a._animationLength)}function b(a){return k()-a._loopTimestamp}function c(a,b){return b>=a._timesToIterate&&a._timesToIterate!==-1}function f(a,b){c(a,b)&&a.stop()}function e(a,b,e){return c(a,e)?a._animationLength:b%a._animationLength}function m(a){var c=b(a),d;d=i(a,c);c=e(a,c,d);f(a,d);a.render(c)}function l(a){a._loopId=setTimeout(function(){l(a);m(a)},1E3/a.config.fps)}if(!_)throw"underscore.js is required for Kapi.";
if(!Tweenable)throw"shifty.js is required for Kapi.";var h,j,k;j={fps:30,height:150,width:300};k=Tweenable.util.now;h=g.Kapi||function(a,b){this.canvas=a;this._context=a.getContext("2d");this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,b);_.defaults(this.config,j);_.each(["height","width"],function(a){this.config[a]&&
(this["canvas_"+a](this.config[a]),delete this.config[a])},this);return this};h.prototype.animationLength=function(){return this._animationLength};h.prototype.actorCount=function(){return this._drawOrder.length};h.prototype.framerate=function(a){if(a)this.config.fps=a;return this.config.fps};h.prototype.render=function(a){this.calculateActorPositions(a);this.draw();this._lastRenderedMillisecond=a;return this};h.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};h.prototype.calculateActorPositions=
function(a){var b,c;c=this._drawOrder.length;for(b=0;b<c;b++)this._actors[this._drawOrder[b]].calculatePosition(a);return this};h.prototype.draw=function(){var a,b,c,e;this.canvas_clear();b=this._drawOrder.length;e=this.canvas_context();for(a=0;a<b;a++)c=this._actors[this._drawOrder[a]],c.draw(e,c.get());return this};h.prototype.updateInternalState=function(){var a;a=[0];_.each(this._drawOrder,function(b){a=a.concat(a,this._actors[b].keyframeList())},this);this._animationLength=Math.max.apply(Math,
a);return this};h.prototype.addActor=function(a,b){_.contains(this._actors,a)||(a.set(b||{}),this._actors[a.id]=a,this._drawOrder.push(a.id),a.setup());return this};h.prototype.getActor=function(a){return this._actors[a]};h.prototype.removeActor=function(a){delete this._actors[a.id];this._drawOrder=_.without(this._drawOrder,a.id);a.teardown();return this};h.prototype.play=function(a){clearTimeout(this._loopId);this._playState==="paused"?this._loopTimestamp+=k()-this._pausedAtTime:this._loopTimestamp=
k();this._timesToIterate=a||-1;this._playState="playing";l(this);_.each(this._actors,function(a){a._state.isPaused&&a.resume()});return this};h.prototype.pause=function(){this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=k();_.each(this._actors,function(a){a._state.isTweening&&a.pause()});return this};h.prototype.stop=function(a){this._playState="stopped";clearTimeout(this._loopId);a===true&&this.canvas_clear();_.each(this._actors,function(a){a.stop()});return this};h.prototype.moveActorToLayer=
function(a,b){if(b<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a};h.prototype.isPlaying=function(){return this._playState==="playing"};h.util={};_.extend(h.util,{noop:function(){},sortNumerically:d});if(typeof KAPI_DEBUG!=="undefined"&&KAPI_DEBUG===true)h._private={sortNumerically:d,calculateLoopPosition:e,renderCurrentMillisecond:m,tick:l,determineCurrentLoopIteration:i,calculateTimeSinceStart:b,isAnimationComplete:c,updatePlayState:f};
g.Kapi=h})(this);
(function(g){var d,i;d=g.Kapi;i=0;d.Actor=function(b,c){c=c||{};this.constructor.call(this,{fps:b.config.fps,initialState:c.initialState});_.extend(this,{_keyframes:{},_keyframeList:[],id:i++,kapi:b,setup:c.setup||d.util.noop,draw:c.draw||d.util.noop,teardown:c.teardown||d.util.noop,_data:{}});return this};g=function(){};g.prototype=Tweenable.prototype;d.Actor.prototype=new g;d.Actor.prototype.calculatePosition=function(b){var c,f,e,d,i;c=this._keyframeList;f=_.first(c);e=_.last(c);if(f<=b&&b<=e){f=
this._keyframes;a:{i=this._keyframeList;d=i.length;for(e=1;e<d;e++)if(i[e]>=b){e-=1;break a}e=-1}d=c[e];i=c[e+1];this.set(f[c[e]].position).interpolate(f[c[e+1]].position,(b-d)/(i-d),f[c[e+1]].easing)}return this};d.Actor.prototype.keyframe=function(b,c,f){var e;f||(f="linear");typeof f==="string"&&(e=f,f={},_.each(c,function(b,c){f[c]=e}));_.each(c,function(b,c){f[c]=f[c]||"linear"});this._keyframes[b]={position:c,easing:f};this._keyframeList.push(b);d.util.sortNumerically(this._keyframeList);this.kapi.updateInternalState();
return this};d.Actor.prototype.liveCopy=function(b,c){var d;this._keyframes.hasOwnProperty(c)&&(d=this._keyframes[c],this.keyframe(b,d.position,d.easing));return this};d.Actor.prototype.modifyKeyframe=function(b,c,d){var e;e=this._keyframes[b];_.each(c,function(b,c){b===void 0||b===null?delete e.position[c]:e.position[c]=b},this);d&&_.each(d,function(b,c){b===void 0||b===null?delete e.easing[c]:e.easing[c]=b},this);return this};d.Actor.prototype.removeKeyframe=function(b){if(this._keyframeList.indexOf(b)!==
-1)this._keyframeList=_.without(this._keyframeList,b),delete this._keyframes[b],this.kapi.updateInternalState();return this};d.Actor.prototype.removeAllKeyframes=function(){var b;b=this._keyframeList.slice(0);_.each(b,function(b){this.removeKeyframe(b)},this);return this};d.Actor.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,b)};d.Actor.prototype.keyframeList=function(){return this._keyframeList};d.Actor.prototype.data=function(b){if(b)this._data=b;return this._data}})(this);
(function(g){function d(d,b,c){typeof c!=="undefined"&&(d[b]=c,d.style[b]=c+"px");return d[b]}g=g.Kapi;g.prototype.canvas_height=function(i){return d(this.canvas,"height",i)};g.prototype.canvas_width=function(i){return d(this.canvas,"width",i)};g.prototype.canvas_style=function(d,b){typeof b!=="undefined"&&(this.canvas.style[d]=b);return this.canvas.style[d]};g.prototype.canvas_clear=function(){this.canvas_context().clearRect(0,0,this.canvas_width(),this.canvas_height());return this};g.prototype.canvas_context=
function(){return this._context}})(this);
(function(g){function d(d,b,c,f,e){var m=/^(__r__|__g__|__b__)/,l;l={};_.each(d,function(b,j){var k;k=j.match(m)?Tweenable.prototype.formula[e[j.slice(5)]]:Tweenable.prototype.formula[e[j]];typeof c[j]!=="undefined"&&(l[j]=g.Tweenable.util.tweenProp(d[j],c[j],k,f))});return l}g.Kapi.Actor.prototype.interpolate=function(i,b,c){var f=this.get(),e;e=g.Tweenable.util.simpleCopy({},f);g.Tweenable.util.applyFilter("tweenCreated",e,[e,f,i]);g.Tweenable.util.applyFilter("beforeTween",e,[e,f,i]);b=d(f,e,i,
b,c);g.Tweenable.util.applyFilter("afterTween",b,[b,f,i]);this.set(b);return b}})(this);
