/*jslint browser: true, nomen: true, plusplus: true, undef: true, sloppy: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.8.19
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(r){var y=function(f,a,d){function j(b,c){return Math.floor(c/b._animationLength)}function i(b){return p()-b._loopTimestamp}function l(b,c){return c>=b._timesToIterate&&-1!==b._timesToIterate}function h(b,c){l(b,c)&&(b.stop(),k(b,"animationComplete"))}function q(b,c,a){return l(b,a)?b._animationLength:c%b._animationLength}function m(b){var c=i(b),a=j(b,c),c=q(b,c,a);b.render(c);h(b,a)}function n(b){var c=function(){n(b);m(b)};b._loopId=b._scheduleUpdate.call?b._scheduleUpdate.call(d,c,1E3/
b.config.fps):setTimeout(c,1E3/b.config.fps)}function k(b,c){e.each(b._events[c],function(c){c(b)})}function g(b){return 60!==b?d.setTimeout:d.requestAnimationFrame||d.webkitRequestAnimationFrame||d.oRequestAnimationFrame||d.msRequestAnimationFrame||d.mozCancelRequestAnimationFrame&&d.mozRequestAnimationFrame||d.setTimeout}function s(b){return 60!==b?d.clearTimeout:d.cancelAnimationFrame||d.webkitCancelAnimationFrame||d.oCancelAnimationFrame||d.msCancelAnimationFrame||d.mozCancelRequestAnimationFrame||
d.clearTimeout}function o(b){b._cancelUpdate.call?b._cancelUpdate.call(d,b._loopId):clearTimeout(b._loopId)}var e=a&&a.underscore?a.underscore:f._,p=(a&&a.Tweenable?a.Tweenable:f.Tweenable).util.now,c={fps:60},a=f.Kapi||function(b){this.config=b||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={frameRender:[],animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeDraw:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;e.extend(this.config,b);e.defaults(this.config,c);this._scheduleUpdate=g(this.config.fps);this._cancelUpdate=s(this.config.fps);e.each(this._contextInitHook,function(b){b.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var b=[];e.each(this._actors,function(c){b.push(c.getEnd())});this._animationLength=Math.max.apply(Math,
b);return this};a.prototype.addActor=function(b){if(!e.contains(this._actors,b))b.context()||b.context(this.context),b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};a.prototype.getActor=function(b){return this._actors[b]};a.prototype.getActorIds=function(){return e.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return e.clone(this._actors)};a.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=
e.without(this._drawOrder,b.id);b.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(b){o(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(p()-this._pausedAtTime):p();this._timesToIterate=b||-1;this._playState="playing";n(this);e.each(this._actors,function(b){b._state.isPaused&&b.resume()});k(this,"playStateChange");k(this,"play");return this};a.prototype.playFrom=function(b,c){this.play(c);this._loopTimestamp=p()-b;return this};a.prototype.playFromCurrent=
function(b){return this.playFrom(this._lastRenderedMillisecond,b)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";o(this);this._pausedAtTime=p();e.each(this._actors,function(b){b._state.isTweening&&b.pause()});k(this,"playStateChange");k(this,"pause");return this};a.prototype.stop=function(){this._playState="stopped";o(this);e.each(this._actors,function(b){b.stop()});k(this,"playStateChange");k(this,"stop");return this};a.prototype.isPlaying=function(){return"playing"===
this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(b){if(b)this.config.fps=b,this._scheduleUpdate=g(this.config.fps),this._cancelUpdate=s(this.config.fps);return this.config.fps};a.prototype.render=function(b){this.calculateActorPositions(b);k(this,"beforeDraw");var c=
this._drawOrder.length,a;this._drawOrderSorter?(a=e.sortBy(this._actors,this._drawOrderSorter),a=e.pluck(a,"id")):a=this._drawOrder;var d,h,g;for(g=0;g<c;g++)d=this._actors[a[g]],h=d.context(),d.render(h,d.get());this._lastRenderedMillisecond=b;k(this,"frameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(b){var c=this._drawOrder.length,a;for(a=0;a<c;a++)this._actors[this._drawOrder[a]].calculatePosition(b);
return this};a.prototype.moveActorToLayer=function(b,c){if(c<this._drawOrder.length)return this._drawOrder=e.without(this._drawOrder,b.id),this._drawOrder.splice(c,0,b.id),b};a.prototype.on=function(b,c){if(this._events[b])return this._events[b].push(c),this};a.prototype.off=function(b,c){if(this._events[b])return this._events[b]=c?e.without(this._events[b],c):[],this};a.prototype.setOrderFunction=function(b){this._drawOrderSorter=b;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=
null;return this};a.prototype.exportTimeline=function(){var b={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};e.each(this._drawOrder,function(c){b.actors[c]=this._actors[c].exportTimeline()},this);return b};a.util={};e.extend(a.util,{noop:function(){},calculateLoopPosition:q,calculateTimeSinceStart:i});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={calculateLoopPosition:q,renderCurrentMillisecond:m,tick:n,determineCurrentLoopIteration:j,calculateTimeSinceStart:i,
isAnimationComplete:l,updatePlayState:h};f.Kapi=a},z=function(f,a){function d(c){return c.sort(function(b,c){return b-c})}function j(c,b){var a=c._timelinePropertyCacheIndex,e=a.length,d;for(d=1;d<e;d++)if(a[d]>=b)return d-1;return-1}function i(c){g.each(c._propertyTracks,function(b,a){c._propertyTracks[a]=g.sortBy(c._propertyTracks[a],function(b){return b.millisecond})})}function l(c){g.each(c._timelinePropertyCaches,function(b,a){var d=h(c,+a);g.defaults(b,d)})}function h(c,b){var a={};g.each(c._propertyTracks,
function(c,d){var e=null;g.find(c,function(c){c.millisecond>b?a[d]=e:c.millisecond===b&&(a[d]=c);e=c;return!!a[d]});if(!a[d]){var h=g.last(c);h&&h.millisecond<=b&&(a[d]=h)}});return a}function q(c){g.each(c._propertyTracks,function(b){g.each(b,function(c,a){c.linkToNext(b[a+1])})})}function m(c,b,a){return g.find(c._propertyTracks[b],function(b){return b.millisecond===a})}function n(c){c._timelinePropertyCaches={};g.each(c._keyframeProperties,function(b){c._timelinePropertyCaches[b.millisecond]||
(c._timelinePropertyCaches[b.millisecond]={});c._timelinePropertyCaches[b.millisecond][b.name]=b},c);c._timelinePropertyCacheIndex=g.keys(c._timelinePropertyCaches);g.each(c._timelinePropertyCacheIndex,function(b,a){c._timelinePropertyCacheIndex[a]=+b},c);d(c._timelinePropertyCacheIndex);l(c);q(c)}var k=0,g=a&&a.underscore?a.underscore:f._,s=a&&a.Tweenable?a.Tweenable:f.Tweenable,o=f.Kapi,e=o.Actor=function(c){c=c||{};this.constructor.call(this);g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},
_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:k++,setup:c.setup||o.util.noop,render:c.render||o.util.noop,teardown:c.teardown||o.util.noop});c.context&&this.context(opt_context);return this},p=function(){};p.prototype=s.prototype;e.prototype=new p;e.prototype.context=function(c){if(c)this._context=c;return this._context};e.prototype.keyframe=function(c,b,a){var d,a=a||"linear";"string"===typeof a&&(d=a,a={},g.each(b,function(b,c){a[c]=d}));g.each(b,function(b,c){a[c]=a[c]||"linear"});g.each(b,
function(b,d){var e=new o.KeyframeProperty(this,c,d,b,a[d]);this._keyframeProperties[e.id]=e;this._propertyTracks[d]||(this._propertyTracks[d]=[]);this._propertyTracks[d].push(e);i(this)},this);this.kapi._recalculateAnimationLength();n(this);return this};e.prototype.getKeyframeProperty=function(c,b){if(this._propertyTracks[c]&&this._propertyTracks[c][b])return this._propertyTracks[c][b]};e.prototype.modifyKeyframeProperty=function(c,b,a){this._propertyTracks[c]&&this._propertyTracks[c][b]&&this._propertyTracks[c][b].modifyWith(a);
i(this);n(this);return this};e.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};e.prototype.getTrackLength=function(c){return!this._propertyTracks[c]?void 0:this._propertyTracks[c].length};e.prototype.copyProperties=function(c,b){var a={},d={};g.each(this._propertyTracks,function(c,e){var h=m(this,e,b);if(h)a[e]=h.value,d[e]=h.easing},this);this.keyframe(c,a,d);return this};e.prototype.wait=function(c){var b=this.getEnd();if(c<=b)return this;var b=this.getEnd(),a=h(this,this.getEnd()),
d={},e={};g.each(a,function(b,c){d[c]=b.value;e[c]=b.easing});this.removeKeyframe(b);this.keyframe(b,d,e);this.keyframe(c,d,e);return this};e.prototype.getStart=function(){var c=[];g.each(this._propertyTracks,function(b){b.length&&c.push(b[0].millisecond)});0===c.length&&(c=[0]);return Math.min.apply(Math,c)};e.prototype.getEnd=function(){var c=0;g.each(this._propertyTracks,function(b){if(b.length)b=g.last(b).millisecond,b>c&&(c=b)},this);return c};e.prototype.getLength=function(){return this.getEnd()-
this.getStart()};e.prototype.modifyKeyframe=function(c,b,a){a=a||{};g.each(this._propertyTracks,function(d,e){var h=m(this,e,c);h&&h.modifyWith({value:b[e],easing:a[e]})},this);return this};e.prototype.removeKeyframe=function(c){g.each(this._propertyTracks,function(b){var a=-1,d=!1;g.find(b,function(b){a++;return d=c===b.millisecond});d&&(b=b.splice(a,1)[0])&&delete this._keyframeProperties[b.id]},this);this.kapi._recalculateAnimationLength();n(this);return this};e.prototype.removeAllKeyframeProperties=
function(){g.each(this._propertyTracks,function(c){c.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};e.prototype.moveToLayer=function(c){return this.kapi.moveActorToLayer(this,c)};e.prototype.calculatePosition=function(c){var b=this.getStart(),a=this.getEnd();if(b<=c&&c<=a){var b=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[j(this,c)]],d={};g.each(b,function(b,a){b&&(d[a]=b.getValueAt(c))});this.set(d)}return this};e.prototype.data=function(c){if(c)this._data=
c;return this._data};e.prototype.exportTimeline=function(){var c={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(b,a){var d=c.propertyTracks[a]=[];g.each(b,function(b){d.push(b.exportPropertyData())})});return c}},A=function(f,a){var d=a&&a.underscore?a.underscore:f._,j=a&&a.Tweenable?a.Tweenable:f.Tweenable,i=f.Kapi.KeyframeProperty=function(a,h,f,j,i){this.id=d.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=
h;this.name=f;this.value=j;this.easing=i||"linear";this.nextProperty=null;return this};i.prototype.modifyWith=function(a){var h={};d.each(["millisecond","easing","value"],function(d){h[d]="undefined"===typeof a[d]?this[d]:a[d]},this);d.extend(this,h)};i.prototype.linkToNext=function(a){this.nextProperty=a||null};i.prototype.getValueAt=function(a){var d={},f={};this.nextProperty?(d[this.name]=this.value,f[this.name]=this.nextProperty.value,a=j.util.interpolate(d,f,(a-this.millisecond)/(this.nextProperty.millisecond-
this.millisecond),this.nextProperty.easing)[this.name]):a=this.value;return a};i.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},t=function(f,a){function d(a,d,f){"undefined"!==typeof f&&(a[d]=f,a.style[d]=f+"px");return a[d]}function j(){this.config.clearOnUpdate&&this.canvasClear()}var i=f.Kapi,l=a&&a.underscore?a.underscore:f._;i.prototype._contextInitHook.canvas=function(){if(this.config.context&&"CANVAS"===
this.config.context.nodeName)this.config.clearOnUpdate=!0,l.each(["Height","Width"],function(a){var d=a.toLowerCase();this.config[d]&&(this["canvas"+a](this.config[d]),delete this.config[a])},this),this.on("beforeDraw",l.bind(j,this))};i.prototype.canvasHeight=function(a){return d(this.context,"height",a)};i.prototype.canvasWidth=function(a){return d(this.context,"width",a)};i.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};
i.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(f){function a(){}var d=f.Kapi;a.prototype=d.Actor.prototype;f=d.CanvasActor=function(a){d.Actor.call(this,a);return this};f.prototype=new a;f.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},v=function(f,a){function d(){}var j=f.Kapi,i=a&&a.underscore?a.underscore:f._,l=["transform","webkitTransform","MozTransform","oTransform","msTransform"];j.DOMActor=function(a){j.Actor.call(this);
this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=" "+a);delete this.render;delete this.teardown;return this};d.prototype=j.Actor.prototype;j.DOMActor.prototype=new d;d.prototype.render=function(a,d){i.each(d,function(d,f){"transform"===f?i.each(l,function(f){a.style[f]=d},this):a.style[f]=d},this)};d.prototype.teardown=function(){var a=this._context.className.match(/\S+/g);this._context.className=i.without(a,this.getCSSName())};d.prototype.getCSSName=
function(){return"actor-"+this.id}},w=function(f,a){function d(a){var d=["{"],e;h.each(a.get(),function(a,c){e=a;var b=c;"transform"===c&&(b=q);d.push(b+":"+e+";")});d.push("}");return d.join("")}function j(a,d,e){var e=e||["w3"],f=[];h.each(e,function(c){c=g(n,[m[c],d,a]).replace(RegExp(q,"g"),m[c]+"transform");f.push(c)});return f.join("\n")}function i(a,d){var d=d||["w3"],e=[],f;h.each(d,function(c){var b=[],c=m[c],d=a.getStart(),h=a.getEnd()-d,h=g("  %sanimation-duration: %sms;",[c,h]);b.push(h);
h=g("  %sanimation-name: %s;",[c,a.getCSSName()+"-keyframes"]);b.push(h);d=g("  %sanimation-delay: %sms;",[c,d]);b.push(d);c=g("  %sanimation-fill-mode: forwards;",[c]);b.push(c);f=b.join("\n");e.push(f)});return g(k,[a.getCSSName(),e.join("\n")])}var l=f.Kapi,h=a&&a.underscore?a.underscore:f._,q="TRANSFORM",m=l.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},n="@%skeyframes %s-keyframes {\n%s\n}",k=".%s {\n  position: absolute;\n%s\n}";f.Kapi.prototype.toCSS=
function(a){var a=a||{},d=[],e=this.getActorIds();h.each(e,function(e){d.push(this.getActor(e).toCSS(a))},this);return d.join("\n")};f.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},f=[],e=a.granularity||100,g=i(this,a.vendors);f.push(g);var g=this.getLength(),c=this.getStart(),b=[],h,e=g/e,l=g/100,k=c+e,m=g+c-e;this.calculatePosition(c);for(b.push("  from "+d(this));k<=m;k+=e)this.calculatePosition(k),h=(k-c)/l,h=+h.toFixed(2),h+="% ",b.push("  "+h+d(this));this.calculatePosition(g+c);b.push("  to "+
d(this));g=b.join("\n");a=j(g,this.getCSSName(),a.vendors);f.push(a);return f.join("\n")};var g=l.util.printf=function(a,d){var e=a;h.each(d,function(a){e=e.replace("%s",a)});return e}},x=function(f,a){var d=a?{}:f;y(d,a,f);z(d,a);A(d,a);"function"===typeof v&&v(d,a);"function"===typeof w&&w(d,a);"function"===typeof t&&t(d,a);"function"===typeof u&&u(d,a);return d.Kapi};if("function"===typeof define&&define.amd){var B="undefined"!==typeof _;define(["shifty","underscore"],function(f,a){var d={Tweenable:f,
underscore:null!==a?a:_},j=x(r,d);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)j.underscore_version=d.underscore.VERSION;if(!B)r._=void 0;return j})}else x("undefined"!==typeof r?r:this)})(this);
