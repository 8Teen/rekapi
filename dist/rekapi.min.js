/**
 * Rekapi - Rewritten Kapi. v0.8.8
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(s){var z=function(f,a,c){function j(d){return d.sort(function(d,b){return d-b})}function k(d,b){return Math.floor(b/d._animationLength)}function n(d){return o()-d._loopTimestamp}function m(d,b){return b>=d._timesToIterate&&-1!==d._timesToIterate}function p(d,b){m(d,b)&&(d.stop(),i(d,"onAnimationComplete"))}function l(d,b,e){return m(d,e)?d._animationLength:b%d._animationLength}function g(d){var b=n(d),e;e=k(d,b);b=l(d,b,e);d.render(b);p(d,e)}function q(d){var b=function(){q(d);g(d)};d._loopId=
d._scheduleUpdate.call?d._scheduleUpdate.call(c,b,1E3/d.config.fps):setTimeout(b,1E3/d.config.fps)}function i(d,b){e.each(d._events[b],function(b){b(d)})}function h(d){return 60!==d?c.setTimeout:c.requestAnimationFrame||c.webkitRequestAnimationFrame||c.oRequestAnimationFrame||c.msRequestAnimationFrame||c.mozCancelRequestAnimationFrame&&c.mozRequestAnimationFrame||c.setTimeout}function b(d){return 60!==d?c.clearTimeout:c.cancelAnimationFrame||c.webkitCancelAnimationFrame||c.oCancelAnimationFrame||
c.msCancelAnimationFrame||c.mozCancelRequestAnimationFrame||c.clearTimeout}function r(d){d._cancelUpdate.call?d._cancelUpdate.call(c,d._loopId):clearTimeout(d._loopId)}var e=a&&a.underscore?a.underscore:f._,o=(a&&a.Tweenable?a.Tweenable:f.Tweenable).util.now,y={fps:60,clearOnUpdate:!0},a=f.Kapi||function(d){this.config=d||{};this.context=this.config.context;this._actors={};this._drawOrder=[];this._playState="stopped";this._drawOrderSorter=null;this._events={onFrameRender:[],onAnimationComplete:[],
onPlayStateChange:[],onPlay:[],onPause:[],onStop:[],onBeforeDraw:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;e.extend(this.config,d);e.defaults(this.config,y);this._scheduleUpdate=h(this.config.fps);this._cancelUpdate=b(this.config.fps);e.each(this._contextInitHook,function(d){d.call(this)},this);return this};a.prototype._contextInitHook={};a.prototype._recalculateAnimationLength=function(){var d=[];e.each(this._actors,
function(b){d.push(b.getEnd())});this._animationLength=Math.max.apply(Math,d);return this};a.prototype.addActor=function(d){if(!e.contains(this._actors,d))d.context()||d.context(this.context),d.kapi=this,d.fps=this.framerate(),this._actors[d.id]=d,this._drawOrder.push(d.id),d.setup();return this};a.prototype.getActor=function(d){return this._actors[d]};a.prototype.getActorIds=function(){return e.pluck(this._actors,"id")};a.prototype.getAllActors=function(){return e.clone(this._actors)};a.prototype.removeActor=
function(d){delete this._actors[d.id];delete d.kapi;this._drawOrder=e.without(this._drawOrder,d.id);d.teardown();this._recalculateAnimationLength();return this};a.prototype.play=function(d){r(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(o()-this._pausedAtTime):o();this._timesToIterate=d||-1;this._playState="playing";q(this);e.each(this._actors,function(d){d._state.isPaused&&d.resume()});i(this,"onPlayStateChange");i(this,"onPlay");return this};a.prototype.playFrom=function(d,
b){this.play(b);this._loopTimestamp=o()-d;return this};a.prototype.playFromCurrent=function(d){return this.playFrom(this._lastRenderedMillisecond,d)};a.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";r(this);this._pausedAtTime=o();e.each(this._actors,function(d){d._state.isTweening&&d.pause()});i(this,"onPlayStateChange");i(this,"onPause");return this};a.prototype.stop=function(){this._playState="stopped";r(this);e.each(this._actors,function(d){d.stop()});
i(this,"onPlayStateChange");i(this,"onStop");return this};a.prototype.isPlaying=function(){return"playing"===this._playState};a.prototype.animationLength=function(){return this._animationLength};a.prototype.lastPositionRendered=function(){return this._lastRenderedMillisecond/this._animationLength};a.prototype.actorCount=function(){return this._drawOrder.length};a.prototype.framerate=function(d){if(d)this.config.fps=d,this._scheduleUpdate=h(this.config.fps),this._cancelUpdate=b(this.config.fps);return this.config.fps};
a.prototype.render=function(d){this.calculateActorPositions(d);var b,r,a,o,c;i(this,"onBeforeDraw");r=this._drawOrder.length;this._drawOrderSorter?(b=e.sortBy(this._actors,this._drawOrderSorter),c=e.pluck(b,"id")):c=this._drawOrder;for(b=0;b<r;b++)a=this._actors[c[b]],o=a.context(),a.render(o,a.get());this._lastRenderedMillisecond=d;i(this,"onFrameRender");return this};a.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};a.prototype.calculateActorPositions=function(d){for(var b=
this._drawOrder.length,e=0;e<b;e++)this._actors[this._drawOrder[e]].calculatePosition(d);return this};a.prototype.moveActorToLayer=function(d,b){if(b<this._drawOrder.length)return this._drawOrder=e.without(this._drawOrder,d.id),this._drawOrder.splice(b,0,d.id),d};a.prototype.bind=function(d,b){if(this._events[d])return this._events[d].push(b),this};a.prototype.unbind=function(d,b){if(this._events[d])return this._events[d]=b?e.without(this._events[d],b):[],this};a.prototype.setOrderFunction=function(d){this._drawOrderSorter=
d;return this};a.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};a.prototype.exportTimeline=function(){var d={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};e.each(this._drawOrder,function(b){d.actors[b]=this._actors[b].exportTimeline()},this);return d};a.util={};e.extend(a.util,{noop:function(){},sortNumerically:j,calculateLoopPosition:l,calculateTimeSinceStart:n});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)a._private={sortNumerically:j,
calculateLoopPosition:l,renderCurrentMillisecond:g,tick:q,determineCurrentLoopIteration:k,calculateTimeSinceStart:n,isAnimationComplete:m,updatePlayState:p};f.Kapi=a},A=function(f,a){function c(b,a){for(var e=b._timelinePropertyCacheIndex,o=e.length,c=1;c<o;c++)if(e[c]>=a)return c-1;return-1}function j(b){g.each(b._propertyTracks,function(a,e){b._propertyTracks[e]=g.sortBy(b._propertyTracks[e],function(b){return b.millisecond})})}function k(b){g.each(b._timelinePropertyCaches,function(a,e){var o=
n(b,+e);g.defaults(a,o)})}function n(b,a){var e={};g.each(b._propertyTracks,function(b,c){var d=null;g.find(b,function(b){b.millisecond>a?e[c]=d:b.millisecond===a&&(e[c]=b);d=b;return!!e[c]});if(!e[c]){var h=g.last(b);h&&h.millisecond<=a&&(e[c]=h)}});return e}function m(b){g.each(b._propertyTracks,function(b){g.each(b,function(e,a){e.linkToNext(b[a+1])})})}function p(b,a,e){return g.find(b._propertyTracks[a],function(b){return b.millisecond===e})}var l=0,g=a&&a.underscore?a.underscore:f._,q=a&&a.Tweenable?
a.Tweenable:f.Tweenable,i=f.Kapi,h=i.Actor=function(b){b=b||{};this.constructor.call(this);g.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isPersisting:!1,id:l++,setup:b.setup||i.util.noop,render:b.render||i.util.noop,teardown:b.teardown||i.util.noop});b.context&&this.context(opt_context);return this};ActorMethods=function(){};ActorMethods.prototype=q.prototype;h.prototype=new ActorMethods;h.prototype.context=function(b){if(b)this._context=
b;return this._context};h.prototype.keyframe=function(b,a,e){var c,e=e||"linear";"string"===typeof e&&(c=e,e={},g.each(a,function(b,d){e[d]=c}));g.each(a,function(b,d){e[d]=e[d]||"linear"});g.each(a,function(a,d){var c;c=new i.KeyframeProperty(this,b,d,a,e[d]);this._keyframeProperties[c.id]=c;this._propertyTracks[d]||(this._propertyTracks[d]=[]);this._propertyTracks[d].push(c);j(this)},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.getKeyframeProperty=
function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};h.prototype.modifyKeyframeProperty=function(b,a,e){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(e);j(this);this.invalidatePropertyCache();return this};h.prototype.getTrackNames=function(){return g.keys(this._propertyTracks)};h.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};h.prototype.copyProperties=
function(b,a){var e,c;e={};c={};g.each(this._propertyTracks,function(b,d){var h;if(h=p(this,d,a))e[d]=h.value,c[d]=h.easing},this);this.keyframe(b,e,c);return this};h.prototype.wait=function(b){var a=this.getEnd();if(b<=a)return this;var a=this.getEnd(),e=n(this,this.getEnd()),c={},h={};g.each(e,function(b,a){c[a]=b.value;h[a]=b.easing});this.removeKeyframe(a);this.keyframe(a,c,h);this.keyframe(b,c,h);return this};h.prototype.getStart=function(){var b=[];g.each(this._propertyTracks,function(a){a.length&&
b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};h.prototype.getEnd=function(){var b=0;g.each(this._propertyTracks,function(a){if(a.length)a=g.last(a).millisecond,a>b&&(b=a)},this);return b};h.prototype.getLength=function(){return this.getEnd()-this.getStart()};h.prototype.modifyKeyframe=function(b,a,e){e=e||{};g.each(this._propertyTracks,function(c,h){var d=p(this,h,b);d&&d.modifyWith({value:a[h],easing:e[h]})},this);return this};h.prototype.removeKeyframe=function(b){g.each(this._propertyTracks,
function(a){var e=-1,c=!1;g.find(a,function(a){e++;return c=b===a.millisecond});c&&(a=a.splice(e,1)[0])&&delete this._keyframeProperties[a.id]},this);this.kapi._recalculateAnimationLength();this.invalidatePropertyCache();return this};h.prototype.removeAllKeyframeProperties=function(){g.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};h.prototype.moveToLayer=function(b){return this.kapi.moveActorToLayer(this,b)};h.prototype.calculatePosition=
function(b){var a=this.getStart(),e=this.getEnd();if(a<=b&&b<=e){var a=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[c(this,b)]],h={};g.each(a,function(a,d){a&&(h[d]=a.getValueAt(b))});this.set(h)}return this};h.prototype.data=function(b){if(b)this._data=b;return this._data};h.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};g.each(this._propertyTracks,function(a,e){var c=b.propertyTracks[e]=[];g.each(a,
function(b){c.push(b.exportPropertyData())})});return b};h.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};g.each(this._keyframeProperties,function(b){this._timelinePropertyCaches[b.millisecond]||(this._timelinePropertyCaches[b.millisecond]={});this._timelinePropertyCaches[b.millisecond][b.name]=b},this);this._timelinePropertyCacheIndex=g.keys(this._timelinePropertyCaches);g.each(this._timelinePropertyCacheIndex,function(b,a){this._timelinePropertyCacheIndex[a]=+b},this);
i.util.sortNumerically(this._timelinePropertyCacheIndex);k(this);m(this)}},B=function(f,a){var c=a&&a.underscore?a.underscore:f._,j=a&&a.Tweenable?a.Tweenable:f.Tweenable,k=f.Kapi.KeyframeProperty=function(a,m,f,j,g){this.id=c.uniqueId("keyframeProperty_");this.ownerActor=a;this.millisecond=m;this.name=f;this.value=j;this.easing=g||"linear";this.nextProperty=null;return this};k.prototype.modifyWith=function(a){var m={};c.each(["millisecond","easing","value"],function(c){m[c]="undefined"===typeof a[c]?
this[c]:a[c]},this);c.extend(this,m)};k.prototype.linkToNext=function(a){this.nextProperty=a||null};k.prototype.getValueAt=function(a){var c,f,l;c={};f={};this.nextProperty?(c[this.name]=this.value,f[this.name]=this.nextProperty.value,l=this.nextProperty.millisecond-this.millisecond,a=(a-this.millisecond)/l,c=j.util.interpolate(c,f,a,this.nextProperty.easing)[this.name]):c=this.value;return c};k.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,
value:this.value,easing:this.easing}}},t=function(f,a){function c(a,c,f){"undefined"!==typeof f&&(a[c]=f,a.style[c]=f+"px");return a[c]}function j(){this.config.clearOnUpdate&&this.canvasClear()}var k=f.Kapi,n=a&&a.underscore?a.underscore:f._;k.prototype._contextInitHook.canvas=function(){this.config.context&&"CANVAS"===this.config.context.nodeName&&(n.each(["Height","Width"],function(a){var c=a.toLowerCase();this.config[c]&&(this["canvas"+a](this.config[c]),delete this.config[a])},this),this.bind("onBeforeDraw",
n.bind(j,this)))};k.prototype.canvasHeight=function(a){return c(this.context,"height",a)};k.prototype.canvasWidth=function(a){return c(this.context,"width",a)};k.prototype.canvasClear=function(){this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};k.prototype.canvasContext=function(){return this.context.getContext("2d")}},u=function(f){function a(){}var c=f.Kapi;a.prototype=c.Actor.prototype;f=c.CanvasActor=function(a){c.Actor.call(this,a);return this};f.prototype=
new a;f.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")}},v=function(f,a){function c(){}var j=f.Kapi,k=a&&a.underscore?a.underscore:f._,n=["transform","webkitTransform","MozTransform","oTransform","msTransform"];j.DOMActor=function(a){j.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=a);delete this.render;return this};c.prototype=j.Actor.prototype;j.DOMActor.prototype=new c;c.prototype.render=
function(a,c){k.each(c,function(c,f){"transform"===f?k.each(n,function(f){a.style[f]=c},this):a.style[f]=c},this)};c.prototype.getCSSName=function(){return"actor-"+this.id}},w=function(f,a,c){function j(a){var b=["{"],c;l.each(a.get(),function(a,h){c=a;var f=h;"transform"===h&&(f=m);b.push(f+":"+c+";")});b.push("}");return b.join("")}function k(a,b,c){var c=c||["w3"],e=[];l.each(c,function(c){c=i(g,[p[c],b,a]).replace(RegExp(m,"g"),p[c]+"transform");e.push(c)});return e.join("\n")}function n(a,b){var b=
b||["w3"],c=[],e;l.each(b,function(b){var f=[],b=p[b],d=a.getStart(),g=a.getEnd()-d,g=i("  %sanimation-duration: %sms;",[b,g]);f.push(g);g=i("  %sanimation-name: %s;",[b,a.getCSSName()+"-keyframes"]);f.push(g);d=i("  %sanimation-delay: %sms;",[b,d]);f.push(d);b=i("  %sanimation-fill-mode: forwards;",[b]);f.push(b);e=f.join("\n");c.push(e)});return i(q,[a.getCSSName(),c.join("\n")])}var m="TRANSFORM",p=f.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},l=
c&&c.underscore?c.underscore:a._,g="@%skeyframes %s-keyframes {\n%s\n}",q=".%s {\n  position: absolute;\n%s\n}";a.Kapi.prototype.toCSS=function(a){var a=a||{},b=[],c=this.getActorIds();l.each(c,function(c){b.push(this.getActor(c).toCSS(a))},this);return b.join("\n")};a.Kapi.Actor.prototype.toCSS=function(a){var a=a||{},b=[],c=a.granularity||100,e=n(this,a.vendors);b.push(e);var e=this.getLength(),f=this.getStart(),g=[],d,c=e/c,i=e/100,l=f+c,m=e+f-c;this.calculatePosition(f);for(g.push("  from "+j(this));l<=
m;l+=c)this.calculatePosition(l),d=(l-f)/i,d=+d.toFixed(2),d+="% ",g.push("  "+d+j(this));this.calculatePosition(e+f);g.push("  to "+j(this));e=g.join("\n");a=k(e,this.getCSSName(),a.vendors);b.push(a);return b.join("\n")};var i=f.util.printf=function(a,b){var c=a;l.each(b,function(a){c=c.replace("%s",a)});return c}},x=function(f,a){var c=a?{}:f;z(c,a,f);A(c,a);B(c,a);"function"===typeof v&&v(c,a);"function"===typeof w&&w(c.Kapi,c,a);"function"===typeof t&&t(c,a);"function"===typeof u&&u(c,a);return c.Kapi};
if("function"===typeof define&&define.amd){var C="undefined"!==typeof _;define(["shifty","underscore"],function(f,a){var c={Tweenable:f,underscore:null!==a?a:_},j=x(s,c);if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)j.underscore_version=c.underscore.VERSION;if(!C)s._=void 0;return j})}else x("undefined"!==typeof s?s:this)})(this);
