/**
 * Rekapi - Rewritten Kapi. v0.4.4
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(g){function j(c){return c.sort(function(c,a){return c-a})}function e(c,a){return Math.floor(a/c._animationLength)}function h(c){return f()-c._loopTimestamp}function k(c,a){return a>=c._timesToIterate&&-1!==c._timesToIterate}function l(c,o){k(c,o)&&(c.stop(),a(c,"onAnimationComplete"))}function n(c,a,b){return k(c,b)?c._animationLength:a%c._animationLength}function i(c){var a=h(c),b;b=e(c,a);a=n(c,a,b);l(c,b);c.render(a)}function m(c){c._loopId=setTimeout(function(){m(c);i(c)},1E3/c.config.fps)}
function a(c,a){_.each(c._events[a],function(a){a(c)})}if(!_)throw"underscore.js is required for Kapi.";if(!Tweenable)throw"shifty.js is required for Kapi.";var b={fps:30,height:150,width:300},f=Tweenable.util.now,d=g.Kapi||function(c,a){this.canvas=c;this._contextType=null;this.canvas_setContext(c);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,a);_.defaults(this.config,b);_.each(["height","width"],function(a){this.config[a]&&(this["canvas_"+a](this.config[a]),delete this.config[a])},this);return this};d.prototype.addActor=function(a){if(!_.contains(this._actors,a))a.kapi=this,a.fps=this.framerate(),this._actors[a.id]=a,this._drawOrder.push(a.id),a.setup();return this};d.prototype.getActor=function(a){return this._actors[a]};
d.prototype.removeActor=function(a){delete this._actors[a.id];delete a.kapi;this._drawOrder=_.without(this._drawOrder,a.id);a.teardown();this.updateInternalState();return this};d.prototype.play=function(c){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(f()-this._pausedAtTime):f();this._timesToIterate=c||-1;this._playState="playing";m(this);_.each(this._actors,function(a){a._state.isPaused&&a.resume()});a(this,"onPlayStateChange");a(this,"onPlay");return this};
d.prototype.playFrom=function(a,b){this.play(b);this._loopTimestamp=f()-a;return this};d.prototype.playFromCurrent=function(a){return this.playFrom(this._lastRenderedMillisecond,a)};d.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=f();_.each(this._actors,function(a){a._state.isTweening&&a.pause()});a(this,"onPlayStateChange");a(this,"onPause");return this};d.prototype.stop=function(c){this._playState="stopped";
clearTimeout(this._loopId);!0===c&&this.canvas_clear();_.each(this._actors,function(a){a.stop();!0===c&&a.hide()});a(this,"onPlayStateChange");a(this,"onStop");return this};d.prototype.isPlaying=function(){return"playing"===this._playState};d.prototype.animationLength=function(){return this._animationLength};d.prototype.actorCount=function(){return this._drawOrder.length};d.prototype.framerate=function(a){if(a)this.config.fps=a;return this.config.fps};d.prototype.render=function(c){this.calculateActorPositions(c);
this.draw();this._lastRenderedMillisecond=c;a(this,"onFrameRender");return this};d.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};d.prototype.calculateActorPositions=function(a){var b,d;d=this._drawOrder.length;for(b=0;b<d;b++)this._actors[this._drawOrder[b]].calculatePosition(a);return this};d.prototype.draw=function(){var a,b,d,f;this.canvas_clear();b=this._drawOrder.length;f=this.canvas_getContext();for(a=0;a<b;a++)d=this._actors[this._drawOrder[a]],d.isShowing()&&
d.draw(f,d.get());return this};d.prototype.updateInternalState=function(){var a=[];_.each(this._actors,function(b){a.push(b.getEnd())});this._animationLength=Math.max.apply(Math,a);return this};d.prototype.moveActorToLayer=function(a,b){if(b<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(b,0,a.id),a};d.prototype.bind=function(a,b){if(this._events[a])return this._events[a].push(b),this};d.prototype.unbind=function(a,b){if(this._events[a])return this._events[a]=
b?_.without(this._events[a],b):[],this};d.util={};_.extend(d.util,{noop:function(){},sortNumerically:j,calculateLoopPosition:n,calculateTimeSinceStart:h});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)d._private={sortNumerically:j,calculateLoopPosition:n,renderCurrentMillisecond:i,tick:m,determineCurrentLoopIteration:e,calculateTimeSinceStart:h,isAnimationComplete:k,updatePlayState:l};g.Kapi=d})(this);
(function(g){function j(a,b){var f,d,c;c=a._timelinePropertyCacheIndex;d=c.length;for(f=1;f<d;f++)if(c[f]>=b)return f-1;return-1}function e(a){_.each(a._propertyTracks,function(b,f){a._propertyTracks[f]=_.sortBy(a._propertyTracks[f],function(a){return a.millisecond})})}function h(a){_.each(a._timelinePropertyCaches,function(b,f){var d={};_.each(a._propertyTracks,function(a,b){var e=null;_.find(a,function(a){a.millisecond>f&&(d[b]=e);e=a;return!!d[b]})});_.defaults(b,d)})}function k(a){_.each(a._propertyTracks,
function(a){_.each(a,function(f,d){f.linkToNext(a[d+1])})})}function l(a,b,f){return _.find(a._propertyTracks[b],function(a){return a.millisecond===f})}function n(a,b,f,d){var c=_.keys(a._propertyTracks),e=_.keys(b),c=_.difference(c,e),i={};_.each(c,function(b){var c;c=a._propertyTracks[b].slice(0).reverse();_.each(c,function(a){a.millisecond<d&&!i[b]&&(i[b]={value:a.value,easing:a.easing})})});_.each(i,function(a,c){b[c]=a.value;f[c]=a.easing})}var i,m;i=g.Kapi;m=0;i.Actor=function(a){a=a||{};this.constructor.call(this);
_.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:m++,setup:a.setup||i.util.noop,draw:a.draw||i.util.noop,teardown:a.teardown||i.util.noop});return this};g=function(){};g.prototype=Tweenable.prototype;i.Actor.prototype=new g;i.Actor.prototype.keyframe=function(a,b,f){var d;f||(f="linear");"string"===typeof f&&(d=f,f={},_.each(b,function(a,b){f[b]=d}));_.each(b,function(a,b){f[b]=f[b]||"linear"});
n(this,b,f,a);_.each(b,function(b,d){var h;h=new i.KeyframeProperty(this,a,d,b,f[d]);this._keyframeProperties[h.id]=h;this._propertyTracks[d]||(this._propertyTracks[d]=[]);this._propertyTracks[d].push(h);e(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.getKeyframeProperty=function(a,b){if(this._propertyTracks[a]&&this._propertyTracks[a][b])return this._propertyTracks[a][b]};i.Actor.prototype.modifyKeyframeProperty=function(a,b,f){this._propertyTracks[a]&&
this._propertyTracks[a][b]&&this._propertyTracks[a][b].modifyWith(f);e(this);this.invalidatePropertyCache();return this};i.Actor.prototype.getTrackNames=function(){return _.keys(this._propertyTracks)};i.Actor.prototype.getTrackLength=function(a){return!this._propertyTracks[a]?void 0:this._propertyTracks[a].length};i.Actor.prototype.copyProperties=function(a,b){var f,d;f={};d={};_.each(this._propertyTracks,function(a,e){var h;if(h=l(this,e,b))f[e]=h.value,d[e]=h.easing},this);this.keyframe(a,f,d);
return this};i.Actor.prototype.wait=function(a){var b=this.getEnd();if(!(a<=b))return this.copyProperties(a,b),this};i.Actor.prototype.getStart=function(){var a=[];_.each(this._propertyTracks,function(b){b.length&&a.push(b[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};i.Actor.prototype.getEnd=function(){var a=0;_.each(this._propertyTracks,function(b){if(b.length)b=_.last(b).millisecond,b>a&&(a=b)},this);return a};i.Actor.prototype.modifyKeyframe=function(a,b,f){f=f||{};_.each(this._propertyTracks,
function(d,c){var e=l(this,c,a);e&&e.modifyWith({value:b[c],easing:f[c]})},this);return this};i.Actor.prototype.removeKeyframe=function(a){_.each(this._propertyTracks,function(b){var f=-1;_.find(b,function(b){f++;return a===b.millisecond});(b=b.splice(f,1)[0])&&delete this._keyframeProperties[b.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.removeAllKeyframeProperties=function(){_.each(this._propertyTracks,function(a){a.length=0},this);this._keyframeProperties=
{};return this.removeKeyframe(0)};i.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};i.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};i.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};i.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};i.Actor.prototype.calculatePosition=function(a){var b,f,d;b=this.getStart();f=this.getEnd();this.hide();b<=a&&
a<=f&&(this.show(),b=j(this,a),b=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[b]],d={},_.each(b,function(b,f){d[f]=b.getValueAt(a)}),this.set(d));return this};i.Actor.prototype.data=function(a){if(a)this._data=a;return this._data};i.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};_.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=
a},this);this._timelinePropertyCacheIndex=_.keys(this._timelinePropertyCaches);_.each(this._timelinePropertyCacheIndex,function(a,b){this._timelinePropertyCacheIndex[b]=+a},this);i.util.sortNumerically(this._timelinePropertyCacheIndex);h(this);k(this)};_.each(["tween","to"],function(a){i.Actor.prototype[a]=function(){this.show(!0);Tweenable.prototype[a].apply(this,arguments)}},this)})(this);
(function(g){var j,e;j=g.Kapi;e=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(g.getComputedStyle)j.DOMActor=function(h){var k;k=new j.Actor({setup:function(){var e=this.kapi.canvas_getContext();"static"===g.getComputedStyle(e).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position="relative");"static"===g.getComputedStyle(h).getPropertyValue("position")&&(h.style.position="absolute")},draw:function(g,j){var i;i=!1;_.each(j,function(g,a){i=!0;"rotate"===
a?_.each(e,function(a){h.style[a]="rotate("+g+"deg)"}):h.style[a]=g});h.style.display=i?"block":"none"}});k.show=function(e){j.Actor.prototype.show.call(this,e);h.style.display="block"};k.hide=function(e){j.Actor.prototype.hide.call(this,e);h.style.display="none"};return k}})(this);
(function(g){function j(e,h,g,j){if("undefined"!==typeof j){e[g]=j;if(!e.style)e.style={};e.style[g]=j+"px"}return h===h.HTML_ELEMENT?e.style[g]:e[g]}g=g.Kapi;g.prototype.canvas_setContext=function(e){var h;this._canvas=e;h=e.nodeName;void 0===h?(this._context={},this._contextType="other"):"CANVAS"===h?(this._context=e.getContext("2d"),this._contextType="canvas"):(this._context=e,this._contextType="HTMLElement");return this.canvas_getContext()};g.prototype.canvas_getContext=function(){return this._context};
g.prototype.canvas_height=function(e){return j(this.canvas,this._contextType,"height",e)};g.prototype.canvas_width=function(e){return j(this.canvas,this._contextType,"width",e)};g.prototype.canvas_style=function(e,h){"undefined"!==typeof h&&this.canvas.style&&(this.canvas.style[e]=h);return this.canvas.style[e]};g.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}})(this);
(function(g){g=g.Kapi;g.KeyframeProperty=function(g,e,h,k,l){this.id=_.uniqueId("keyframeProperty_");this.ownerActor=g;this.millisecond=e;this.name=h;this.value=k;this.easing=l||"linear";this.nextProperty=null;return this};g.KeyframeProperty.prototype.modifyWith=function(g){var e={};_.each(["millisecond","easing","value"],function(h){e[h]="undefined"===typeof g[h]?this[h]:g[h]},this);_.extend(this,e)};g.KeyframeProperty.prototype.linkToNext=function(g){this.nextProperty=g||null};g.KeyframeProperty.prototype.getValueAt=
function(g){var e,h,k;e={};h={};this.nextProperty?(e[this.name]=this.value,h[this.name]=this.nextProperty.value,k=this.nextProperty.millisecond-this.millisecond,g=(g-this.millisecond)/k,e=Tweenable.util.interpolate(e,h,g,this.nextProperty.easing)[this.name]):e=null;return e}})(this);
