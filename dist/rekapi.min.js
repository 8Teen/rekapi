/**
 * Rekapi - Rewritten Kapi. v0.3.5
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(e){function j(b){return b.sort(function(b,a){return b-a})}function i(b,a){return Math.floor(a/b._animationLength)}function c(b){return l()-b._loopTimestamp}function h(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function a(b,a){h(b,a)&&(b.stop(),g(b,"onAnimationComplete"))}function k(b,a,d){return h(b,d)?b._animationLength:a%b._animationLength}function f(b){var d=c(b),f;f=i(b,d);d=k(b,d,f);a(b,f);b.render(d)}function m(b){b._loopId=setTimeout(function(){m(b);f(b)},1E3/b.config.fps)}
function g(b,a){_.each(b._events[a],function(a){a(b)})}if(!_)throw"underscore.js is required for Kapi.";if(!Tweenable)throw"shifty.js is required for Kapi.";var d,n,l;n={fps:30,height:150,width:300};l=Tweenable.util.now;d=e.Kapi||function(b,a){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,a);_.defaults(this.config,n);_.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};d.prototype.addActor=function(b,a){if(!_.contains(this._actors,b))b.kapi=this,b.fps=this.framerate(),b.set(a||{}),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};d.prototype.getActor=
function(b){return this._actors[b]};d.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=_.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};d.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(l()-this._pausedAtTime):l();this._timesToIterate=b||-1;this._playState="playing";m(this);_.each(this._actors,function(b){b._state.isPaused&&b.resume()});g(this,"onPlayStateChange");
g(this,"onPlay");return this};d.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=l()-b;return this};d.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};d.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=l();_.each(this._actors,function(b){b._state.isTweening&&b.pause()});g(this,"onPlayStateChange");g(this,"onPause");return this};d.prototype.stop=function(b){this._playState=
"stopped";clearTimeout(this._loopId);!0===b&&this.canvas_clear();_.each(this._actors,function(a){a.stop();!0===b&&a.hide()});g(this,"onPlayStateChange");g(this,"onStop");return this};d.prototype.isPlaying=function(){return"playing"===this._playState};d.prototype.animationLength=function(){return this._animationLength};d.prototype.actorCount=function(){return this._drawOrder.length};d.prototype.framerate=function(b){if(b)this.config.fps=b;return this.config.fps};d.prototype.render=function(b){this.calculateActorPositions(b);
this.draw();this._lastRenderedMillisecond=b;g(this,"onFrameRender");return this};d.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};d.prototype.calculateActorPositions=function(b){var a,d;d=this._drawOrder.length;for(a=0;a<d;a++)this._actors[this._drawOrder[a]].calculatePosition(b);return this};d.prototype.draw=function(){var b,a,d,c;this.canvas_clear();a=this._drawOrder.length;c=this.canvas_getContext();for(b=0;b<a;b++)d=this._actors[this._drawOrder[b]],d.isShowing()&&
d.draw(c,d.get());return this};d.prototype.updateInternalState=function(){var b;b=[0];_.each(this._drawOrder,function(a){b=b.concat(b,this._actors[a].keyframeList());b=_.uniq(b)},this);this._animationLength=Math.max.apply(Math,b);return this};d.prototype.moveActorToLayer=function(b,a){if(a<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,b.id),this._drawOrder.splice(a,0,b.id),b};d.prototype.bind=function(b,a){if(this._events[b])return this._events[b].push(a),this};d.prototype.unbind=
function(b,a){if(this._events[b])return this._events[b]=a?_.without(this._events[b],a):[],this};d.prototype.exportKeyframeData=function(){var b;b={};_.each(this._actors,function(a,d){var c;c=a.exportKeyframeData();b[d]={actor:a,keyframeList:c.keyframeList,keyframes:c.keyframes}});return b};d.util={};_.extend(d.util,{noop:function(){},sortNumerically:j,calculateLoopPosition:k,calculateTimeSinceStart:c});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)d._private={sortNumerically:j,calculateLoopPosition:k,
renderCurrentMillisecond:f,tick:m,determineCurrentLoopIteration:i,calculateTimeSinceStart:c,isAnimationComplete:h,updatePlayState:a};e.Kapi=d})(this);
(function(e){function j(a,c){_.each(c,function(c,k){void 0===c||null===c?delete a[k]:a[k]=c})}function i(a,c){var f,i,g,d;f=a._keyframeList;i=a._keyframes;g={position:{},easing:{}};for(d=c;0<=d;d--)_.defaults(g.position,i[f[d]].position),_.defaults(g.easing,i[f[d]].easing);return g}var c,h;c=e.Kapi;h=0;c.Actor=function(a){a=a||{};this.constructor.call(this);_.extend(this,{_keyframes:{},_keyframeList:[],_data:{},_isShowing:!1,_isPersisting:!1,id:h++,setup:a.setup||c.util.noop,draw:a.draw||c.util.noop,
teardown:a.teardown||c.util.noop});return this};e=function(){};e.prototype=Tweenable.prototype;c.Actor.prototype=new e;c.Actor.prototype.keyframe=function(a,k,f){var i;f||(f="linear");"string"===typeof f&&(i=f,f={},_.each(k,function(a,d){f[d]=i}));_.each(k,function(a,d){f[d]=f[d]||"linear"});this._keyframes[a]={position:k,easing:f};this._keyframeList.push(a);c.util.sortNumerically(this._keyframeList);this.kapi.updateInternalState();return this};c.Actor.prototype.liveCopy=function(a,c){var f;"undefined"===
typeof c&&(c=_.last(this._keyframeList));this._keyframes.hasOwnProperty(c)&&(f=this._keyframes[c],this.keyframe(a,f.position,f.easing));return this};c.Actor.prototype.modifyKeyframe=function(a,c,f){a=this._keyframes[a];j(a.position,c);f&&j(a.easing,f);return this};c.Actor.prototype.removeKeyframe=function(a){if(-1!==this._keyframeList.indexOf(a))this._keyframeList=_.without(this._keyframeList,a),delete this._keyframes[a],this.kapi.updateInternalState();return this};c.Actor.prototype.removeAllKeyframes=
function(){var a;a=this._keyframeList.slice(0);_.each(a,function(a){this.removeKeyframe(a)},this);return this};c.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};c.Actor.prototype.show=function(a){this._isShowing=!0;this._isPersisting=!!a;return this};c.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};c.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};c.Actor.prototype.calculatePosition=
function(a){var c,f,e,g,d;c=this._keyframeList;f=_.first(c);e=_.last(c);this.hide();if(f<=a&&a<=e){this.show();f=this._keyframes;a:{d=this._keyframeList;g=d.length;for(e=1;e<g;e++)if(d[e]>=a){e-=1;break a}e=-1}g=c[e];d=c[e+1];a=(a-g)/(d-g);g=i(this,e);c=_.extend({},f[c[e+1]]);_.defaults(c.position,g.position);_.defaults(c.easing,g.easing);this.set(g.position).interpolate(c.position,a,c.easing)}return this};c.Actor.prototype.keyframeList=function(){return this._keyframeList};c.Actor.prototype.data=
function(a){if(a)this._data=a;return this._data};c.Actor.prototype.exportKeyframeData=function(){return{keyframeList:this._keyframeList.slice(0),keyframes:_.extend({},this._keyframes)}};_.each(["tween","to"],function(a){c.Actor.prototype[a]=function(){this.show(!0);Tweenable.prototype[a].apply(this,arguments)}},this);_.extend(c.util,{composeKeyframe:i})})(this);
(function(e){var j,i;j=e.Kapi;i=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(e.getComputedStyle)j.DOMActor=function(c){var h;h=new j.Actor({setup:function(){var a=this.kapi.canvas_getContext();"static"===e.getComputedStyle(a).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position="relative");"static"===e.getComputedStyle(c).getPropertyValue("position")&&(c.style.position="absolute")},draw:function(a,e){var f;f=!1;_.each(e,function(a,e){f=!0;"rotate"===
e?_.each(i,function(d){c.style[d]="rotate("+a+"deg)"}):c.style[e]=a});c.style.display=f?"block":"none"}});h.show=function(a){j.Actor.prototype.show.call(this,a);c.style.display="block"};h.hide=function(a){j.Actor.prototype.hide.call(this,a);c.style.display="none"};return h}})(this);
(function(e){function j(e,c,h,a){if("undefined"!==typeof a){e[h]=a;if(!e.style)e.style={};e.style[h]=a+"px"}return c===c.HTML_ELEMENT?e.style[h]:e[h]}e=e.Kapi;e.prototype.canvas_setContext=function(e){var c;this._canvas=e;c=e.nodeName;void 0===c?(this._context={},this._contextType="other"):"CANVAS"===c?(this._context=e.getContext("2d"),this._contextType="canvas"):(this._context=e,this._contextType="HTMLElement");return this.canvas_getContext()};e.prototype.canvas_getContext=function(){return this._context};
e.prototype.canvas_height=function(e){return j(this.canvas,this._contextType,"height",e)};e.prototype.canvas_width=function(e){return j(this.canvas,this._contextType,"width",e)};e.prototype.canvas_style=function(e,c){"undefined"!==typeof c&&this.canvas.style&&(this.canvas.style[e]=c);return this.canvas.style[e]};e.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}})(this);
