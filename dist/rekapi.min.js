/**
 * Rekapi - Rewritten Kapi. v0.4.3
 *   By Jeremy Kahn - jeremyckahn@gmail.com
 *   https://github.com/jeremyckahn/rekapi
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore), Shifty.js (https://github.com/jeremyckahn/shifty)
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(f){function j(b){return b.sort(function(b,a){return b-a})}function d(b,a){return Math.floor(a/b._animationLength)}function h(b){return g()-b._loopTimestamp}function k(b,a){return a>=b._timesToIterate&&-1!==b._timesToIterate}function l(b,o){k(b,o)&&(b.stop(),a(b,"onAnimationComplete"))}function n(b,a,c){return k(b,c)?b._animationLength:a%b._animationLength}function i(b){var a=h(b),c;c=d(b,a);a=n(b,a,c);l(b,c);b.render(a)}function m(b){b._loopId=setTimeout(function(){m(b);i(b)},1E3/b.config.fps)}
function a(b,a){_.each(b._events[a],function(a){a(b)})}if(!_)throw"underscore.js is required for Kapi.";if(!Tweenable)throw"shifty.js is required for Kapi.";var c={fps:30,height:150,width:300},g=Tweenable.util.now,e=f.Kapi||function(b,a){this.canvas=b;this._contextType=null;this.canvas_setContext(b);this.config={};this._actors={};this._drawOrder=[];this._playState="stopped";this._events={onFrameRender:[],onAnimationComplete:[],onPlayStateChange:[],onPlay:[],onPause:[],onStop:[]};this._timesToIterate=
-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=this._loopId=null;this._lastRenderedMillisecond=0;_.extend(this.config,a);_.defaults(this.config,c);_.each(["height","width"],function(b){this.config[b]&&(this["canvas_"+b](this.config[b]),delete this.config[b])},this);return this};e.prototype.addActor=function(b){if(!_.contains(this._actors,b))b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._drawOrder.push(b.id),b.setup();return this};e.prototype.getActor=function(b){return this._actors[b]};
e.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;this._drawOrder=_.without(this._drawOrder,b.id);b.teardown();this.updateInternalState();return this};e.prototype.play=function(b){clearTimeout(this._loopId);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(g()-this._pausedAtTime):g();this._timesToIterate=b||-1;this._playState="playing";m(this);_.each(this._actors,function(b){b._state.isPaused&&b.resume()});a(this,"onPlayStateChange");a(this,"onPlay");return this};
e.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=g()-b;return this};e.prototype.playFromCurrent=function(b){return this.playFrom(this._lastRenderedMillisecond,b)};e.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";clearTimeout(this._loopId);this._pausedAtTime=g();_.each(this._actors,function(b){b._state.isTweening&&b.pause()});a(this,"onPlayStateChange");a(this,"onPause");return this};e.prototype.stop=function(b){this._playState="stopped";
clearTimeout(this._loopId);!0===b&&this.canvas_clear();_.each(this._actors,function(a){a.stop();!0===b&&a.hide()});a(this,"onPlayStateChange");a(this,"onStop");return this};e.prototype.isPlaying=function(){return"playing"===this._playState};e.prototype.animationLength=function(){return this._animationLength};e.prototype.actorCount=function(){return this._drawOrder.length};e.prototype.framerate=function(b){if(b)this.config.fps=b;return this.config.fps};e.prototype.render=function(b){this.calculateActorPositions(b);
this.draw();this._lastRenderedMillisecond=b;a(this,"onFrameRender");return this};e.prototype.redraw=function(){this.render(this._lastRenderedMillisecond);return this};e.prototype.calculateActorPositions=function(b){var a,c;c=this._drawOrder.length;for(a=0;a<c;a++)this._actors[this._drawOrder[a]].calculatePosition(b);return this};e.prototype.draw=function(){var b,a,c,e;this.canvas_clear();a=this._drawOrder.length;e=this.canvas_getContext();for(b=0;b<a;b++)c=this._actors[this._drawOrder[b]],c.isShowing()&&
c.draw(e,c.get());return this};e.prototype.updateInternalState=function(){var a=[];_.each(this._actors,function(c){a.push(c.getEnd())});this._animationLength=Math.max.apply(Math,a);return this};e.prototype.moveActorToLayer=function(a,c){if(c<this._drawOrder.length)return this._drawOrder=_.without(this._drawOrder,a.id),this._drawOrder.splice(c,0,a.id),a};e.prototype.bind=function(a,c){if(this._events[a])return this._events[a].push(c),this};e.prototype.unbind=function(a,c){if(this._events[a])return this._events[a]=
c?_.without(this._events[a],c):[],this};e.util={};_.extend(e.util,{noop:function(){},sortNumerically:j,calculateLoopPosition:n,calculateTimeSinceStart:h});if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)e._private={sortNumerically:j,calculateLoopPosition:n,renderCurrentMillisecond:i,tick:m,determineCurrentLoopIteration:d,calculateTimeSinceStart:h,isAnimationComplete:k,updatePlayState:l};f.Kapi=e})(this);
(function(f){function j(a,c){var g,e,b;b=a._timelinePropertyCacheIndex;e=b.length;for(g=1;g<e;g++)if(b[g]>=c)return g-1;return-1}function d(a){_.each(a._propertyTracks,function(c,g){a._propertyTracks[g]=_.sortBy(a._propertyTracks[g],function(a){return a.millisecond})})}function h(a){_.each(a._timelinePropertyCaches,function(c,g){var e={};_.each(a._propertyTracks,function(a,c){var d=null;_.find(a,function(a){a.millisecond>g&&(e[c]=d);d=a;return!!e[c]})});_.defaults(c,e)})}function k(a){_.each(a._propertyTracks,
function(a){_.each(a,function(g,e){g.linkToNext(a[e+1])})})}function l(a,c,g){return _.find(a._propertyTracks[c],function(a){return a.millisecond===g})}function n(a,c,g,e){var b=_.keys(a._propertyTracks),d=_.keys(c),b=_.difference(b,d),h={};_.each(b,function(b){var c;c=a._propertyTracks[b].slice(0).reverse();_.each(c,function(a){a.millisecond<e&&!h[b]&&(h[b]={value:a.value,easing:a.easing})})});_.each(h,function(a,b){c[b]=a.value;g[b]=a.easing})}var i,m;i=f.Kapi;m=0;i.Actor=function(a){a=a||{};this.constructor.call(this);
_.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},_isShowing:!1,_isPersisting:!1,id:m++,setup:a.setup||i.util.noop,draw:a.draw||i.util.noop,teardown:a.teardown||i.util.noop});return this};f=function(){};f.prototype=Tweenable.prototype;i.Actor.prototype=new f;i.Actor.prototype.keyframe=function(a,c,g){var e;g||(g="linear");"string"===typeof g&&(e=g,g={},_.each(c,function(a,c){g[c]=e}));_.each(c,function(a,c){g[c]=g[c]||"linear"});
n(this,c,g,a);_.each(c,function(b,c){var e;e=new i.KeyframeProperty(this,a,c,b,g[c]);this._keyframeProperties[e.id]=e;this._propertyTracks[c]||(this._propertyTracks[c]=[]);this._propertyTracks[c].push(e);d(this)},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.modifyKeyframeProperty=function(a,c,g){this._propertyTracks[a]&&this._propertyTracks[a][c]&&this._propertyTracks[a][c].modifyWith(g);d(this);this.invalidatePropertyCache();return this};i.Actor.prototype.getTrackNames=
function(){return _.keys(this._propertyTracks)};i.Actor.prototype.getTrackLength=function(a){return!this._propertyTracks[a]?void 0:this._propertyTracks[a].length};i.Actor.prototype.copyProperties=function(a,c){var g,e;g={};e={};_.each(this._propertyTracks,function(a,d){var h;if(h=l(this,d,c))g[d]=h.value,e[d]=h.easing},this);this.keyframe(a,g,e);return this};i.Actor.prototype.wait=function(a){var c=this.getEnd();if(!(a<=c))return this.copyProperties(a,c),this};i.Actor.prototype.getStart=function(){var a=
[];_.each(this._propertyTracks,function(c){c.length&&a.push(c[0].millisecond)});0===a.length&&(a=[0]);return Math.min.apply(Math,a)};i.Actor.prototype.getEnd=function(){var a=0;_.each(this._propertyTracks,function(c){if(c.length)c=_.last(c).millisecond,c>a&&(a=c)},this);return a};i.Actor.prototype.modifyKeyframe=function(a,c,g){g=g||{};_.each(this._propertyTracks,function(e,b){var d=l(this,b,a);d&&d.modifyWith({value:c[b],easing:g[b]})},this);return this};i.Actor.prototype.removeKeyframe=function(a){_.each(this._propertyTracks,
function(c){var d=-1;_.find(c,function(c){d++;return a===c.millisecond});(c=c.splice(d,1)[0])&&delete this._keyframeProperties[c.id]},this);this.kapi.updateInternalState();this.invalidatePropertyCache();return this};i.Actor.prototype.removeAllKeyframeProperties=function(){_.each(this._propertyTracks,function(a){a.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};i.Actor.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)};i.Actor.prototype.show=function(a){this._isShowing=
!0;this._isPersisting=!!a;return this};i.Actor.prototype.hide=function(a){this._isShowing=!1;if(!0===a)this._isPersisting=!1;return this};i.Actor.prototype.isShowing=function(){return this._isShowing||this._isPersisting};i.Actor.prototype.calculatePosition=function(a){var c,d,e;c=this.getStart();d=this.getEnd();this.hide();c<=a&&a<=d&&(this.show(),c=j(this,a),c=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[c]],e={},_.each(c,function(b,c){e[c]=b.getValueAt(a)}),this.set(e));return this};
i.Actor.prototype.data=function(a){if(a)this._data=a;return this._data};i.Actor.prototype.invalidatePropertyCache=function(){this._timelinePropertyCaches={};_.each(this._keyframeProperties,function(a){this._timelinePropertyCaches[a.millisecond]||(this._timelinePropertyCaches[a.millisecond]={});this._timelinePropertyCaches[a.millisecond][a.name]=a},this);this._timelinePropertyCacheIndex=_.keys(this._timelinePropertyCaches);_.each(this._timelinePropertyCacheIndex,function(a,c){this._timelinePropertyCacheIndex[c]=
+a},this);i.util.sortNumerically(this._timelinePropertyCacheIndex);h(this);k(this)};_.each(["tween","to"],function(a){i.Actor.prototype[a]=function(){this.show(!0);Tweenable.prototype[a].apply(this,arguments)}},this)})(this);
(function(f){var j,d;j=f.Kapi;d=["transform","webkitTransform","MozTransform","oTransform","msTransform"];if(f.getComputedStyle)j.DOMActor=function(h){var k;k=new j.Actor({setup:function(){var d=this.kapi.canvas_getContext();"static"===f.getComputedStyle(d).getPropertyValue("position")&&(this.kapi.canvas_getContext().style.position="relative");"static"===f.getComputedStyle(h).getPropertyValue("position")&&(h.style.position="absolute")},draw:function(f,j){var i;i=!1;_.each(j,function(f,a){i=!0;"rotate"===
a?_.each(d,function(a){h.style[a]="rotate("+f+"deg)"}):h.style[a]=f});h.style.display=i?"block":"none"}});k.show=function(d){j.Actor.prototype.show.call(this,d);h.style.display="block"};k.hide=function(d){j.Actor.prototype.hide.call(this,d);h.style.display="none"};return k}})(this);
(function(f){function j(d,h,f,j){if("undefined"!==typeof j){d[f]=j;if(!d.style)d.style={};d.style[f]=j+"px"}return h===h.HTML_ELEMENT?d.style[f]:d[f]}f=f.Kapi;f.prototype.canvas_setContext=function(d){var h;this._canvas=d;h=d.nodeName;void 0===h?(this._context={},this._contextType="other"):"CANVAS"===h?(this._context=d.getContext("2d"),this._contextType="canvas"):(this._context=d,this._contextType="HTMLElement");return this.canvas_getContext()};f.prototype.canvas_getContext=function(){return this._context};
f.prototype.canvas_height=function(d){return j(this.canvas,this._contextType,"height",d)};f.prototype.canvas_width=function(d){return j(this.canvas,this._contextType,"width",d)};f.prototype.canvas_style=function(d,h){"undefined"!==typeof h&&this.canvas.style&&(this.canvas.style[d]=h);return this.canvas.style[d]};f.prototype.canvas_clear=function(){"canvas"===this._contextType&&this.canvas_getContext().clearRect(0,0,this.canvas_width(),this.canvas_height());return this}})(this);
(function(f){f=f.Kapi;f.KeyframeProperty=function(f,d,h,k,l){this.id=_.uniqueId("keyframeProperty_");this.ownerActor=f;this.millisecond=d;this.name=h;this.value=k;this.easing=l||"linear";this.nextProperty=null;return this};f.KeyframeProperty.prototype.modifyWith=function(f){var d={};_.each(["millisecond","easing","value"],function(h){d[h]="undefined"===typeof f[h]?this[h]:f[h]},this);_.extend(this,d)};f.KeyframeProperty.prototype.linkToNext=function(f){this.nextProperty=f||null};f.KeyframeProperty.prototype.getValueAt=
function(f){var d,h,k;d={};h={};this.nextProperty?(d[this.name]=this.value,h[this.name]=this.nextProperty.value,k=this.nextProperty.millisecond-this.millisecond,f=(f-this.millisecond)/k,d=Tweenable.util.interpolate(d,h,f,this.nextProperty.easing)[this.name]):d=null;return d}})(this);
