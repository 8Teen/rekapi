/*jslint browser: true, nomen: true, plusplus: true, undef: true, vars: true, white: true */
/**
 * Rekapi - Rewritten Kapi. v0.9.3
 * https://github.com/jeremyckahn/rekapi
 *
 * By Jeremy Kahn (jeremyckahn@gmail.com), with significant contributions from
 *   Franck Lecollinet
 *
 * Make fun keyframe animations with JavaScript.
 * Dependencies: Underscore.js (https://github.com/documentcloud/underscore),
 *   Shifty.js (https://github.com/jeremyckahn/shifty).
 * MIT Lincense.  This code free to use, modify, distribute and enjoy.
 */
(function(s){function f(d,a,c,h){c.each(d._events[a],function(a){a(d,h)})}function t(){}var z=function(d,a,c){function h(e,b){return Math.floor(b/e._animationLength)}function m(e){return g()-e._loopTimestamp}function n(e,b){return b>=e._timesToIterate&&-1!==e._timesToIterate}function q(e,b){n(e,b)&&(e.stop(),f(e,"animationComplete",a))}function i(e,b,a){return n(e,a)?e._animationLength:b%e._animationLength}function j(b){var a=m(b),g=h(b,a),a=i(b,a,g);b.update(a);q(b,g)}function o(e){var a=function(){o(e);
j(e)};e._loopId=e._scheduleUpdate.call?e._scheduleUpdate.call(b,a,1E3/e.config.fps):setTimeout(a,1E3/e.config.fps)}function k(e){return 60!==e?b.setTimeout:b.requestAnimationFrame||b.webkitRequestAnimationFrame||b.oRequestAnimationFrame||b.msRequestAnimationFrame||b.mozCancelRequestAnimationFrame&&b.mozRequestAnimationFrame||b.setTimeout}function p(e){return 60!==e?b.clearTimeout:b.cancelAnimationFrame||b.webkitCancelAnimationFrame||b.oCancelAnimationFrame||b.msCancelAnimationFrame||b.mozCancelRequestAnimationFrame||
b.clearTimeout}function r(e){e._cancelUpdate.call?e._cancelUpdate.call(b,e._loopId):clearTimeout(e._loopId)}var b=Function("return this")(),g=c.util.now,l={fps:60},c=d.Kapi||function(b){this.config=b||{};this.context=this.config.context;this._actors={};this._playState="stopped";this._events={animationComplete:[],playStateChange:[],play:[],pause:[],stop:[],beforeUpdate:[],afterUpdate:[],addActor:[],removeActor:[]};this._timesToIterate=-1;this._animationLength=0;this._pausedAtTime=this._loopTimestamp=
this._loopId=null;this._lastUpdatedMillisecond=0;a.extend(this.config,b);a.defaults(this.config,l);this._scheduleUpdate=k(this.config.fps);this._cancelUpdate=p(this.config.fps);a.each(this._contextInitHook,function(b){b.call(this)},this);return this};c.prototype._contextInitHook={};c.prototype._recalculateAnimationLength=function(){var b=[];a.each(this._actors,function(a){b.push(a.getEnd())});this._animationLength=Math.max.apply(Math,b);return this};c.prototype.addActor=function(b){if(!a.contains(this._actors,
b))b.context()||b.context(this.context),b.kapi=this,b.fps=this.framerate(),this._actors[b.id]=b,this._recalculateAnimationLength(),b.setup(),f(this,"addActor",a,b);return this};c.prototype.getActor=function(b){return this._actors[b]};c.prototype.getActorIds=function(){return a.pluck(this._actors,"id")};c.prototype.getAllActors=function(){return a.clone(this._actors)};c.prototype.removeActor=function(b){delete this._actors[b.id];delete b.kapi;b.teardown();this._recalculateAnimationLength();f(this,
"removeActor",a,b);return this};c.prototype.play=function(b){r(this);this._loopTimestamp="paused"===this._playState?this._loopTimestamp+(g()-this._pausedAtTime):g();this._timesToIterate=b||-1;this._playState="playing";o(this);a.each(this._actors,function(b){b._state.isPaused&&b.resume()});f(this,"playStateChange",a);f(this,"play",a);return this};c.prototype.playFrom=function(b,a){this.play(a);this._loopTimestamp=g()-b;return this};c.prototype.playFromCurrent=function(b){return this.playFrom(this._lastUpdatedMillisecond,
b)};c.prototype.pause=function(){if("paused"===this._playState)return this;this._playState="paused";r(this);this._pausedAtTime=g();a.each(this._actors,function(b){b._state.isTweening&&b.pause()});f(this,"playStateChange",a);f(this,"pause",a);return this};c.prototype.stop=function(){this._playState="stopped";r(this);a.each(this._actors,function(b){b.stop()});f(this,"playStateChange",a);f(this,"stop",a);return this};c.prototype.isPlaying=function(){return"playing"===this._playState};c.prototype.animationLength=
function(){return this._animationLength};c.prototype.lastPositionUpdated=function(){return this._lastUpdatedMillisecond/this._animationLength};c.prototype.actorCount=function(){return a.size(this._actors)};c.prototype.framerate=function(b){if(b)this.config.fps=b,this._scheduleUpdate=k(this.config.fps),this._cancelUpdate=p(this.config.fps);return this.config.fps};c.prototype.update=function(b){f(this,"beforeUpdate",a);a.each(this._actors,function(a){a.updateState(b);"function"===typeof a.update&&a.update(a.context(),
a.get())});this._lastUpdatedMillisecond=b;f(this,"afterUpdate",a);return this};c.prototype.on=function(b,a){if(this._events[b])return this._events[b].push(a),this};c.prototype.off=function(b,g){if(this._events[b])return this._events[b]=g?a.without(this._events[b],g):[],this};c.prototype.exportTimeline=function(){var b={duration:this._animationLength,actors:{}};a.each(this._actors,function(a){b.actors[a.id]=a.exportTimeline()},this);return b};c.util={};a.extend(c.util,{calculateLoopPosition:i,calculateTimeSinceStart:m});
if("undefined"!==typeof KAPI_DEBUG&&!0===KAPI_DEBUG)c._private={calculateLoopPosition:i,updateToCurrentMillisecond:j,tick:o,determineCurrentLoopIteration:h,calculateTimeSinceStart:m,isAnimationComplete:n,updatePlayState:q};d.Kapi=c},A=function(d,a,c){function h(b){return b.sort(function(b,a){return b-a})}function m(b,a){var l=b._timelinePropertyCacheIndex,e=l.length,c;for(c=1;c<e;c++)if(l[c]>=a)return c-1;return-1}function n(b){a.each(b._propertyTracks,function(g,l){b._propertyTracks[l]=a.sortBy(b._propertyTracks[l],
function(b){return b.millisecond})})}function f(b){a.each(b._timelinePropertyCaches,function(g,l){var e=i(b,+l);a.defaults(g,e)})}function i(b,g){var l={};a.each(b._propertyTracks,function(b,c){var d=null;a.find(b,function(b){b.millisecond>g?l[c]=d:b.millisecond===g&&(l[c]=b);d=b;return!!l[c]});if(!l[c]){var j=a.last(b);j&&j.millisecond<=g&&(l[c]=j)}});return l}function j(b){a.each(b._propertyTracks,function(b){a.each(b,function(a,e){a.linkToNext(b[e+1])})})}function o(b,g,c){return a.find(b._propertyTracks[g],
function(b){return b.millisecond===c})}function k(b){b._timelinePropertyCaches={};a.each(b._keyframeProperties,function(a){b._timelinePropertyCaches[a.millisecond]||(b._timelinePropertyCaches[a.millisecond]={});b._timelinePropertyCaches[a.millisecond][a.name]=a},b);b._timelinePropertyCacheIndex=a.keys(b._timelinePropertyCaches);a.each(b._timelinePropertyCacheIndex,function(a,c){b._timelinePropertyCacheIndex[c]=+a},b);h(b._timelinePropertyCacheIndex);f(b);j(b)}var p=d.Kapi,d=p.Actor=function(b){b=
b||{};this.constructor.call(this);a.extend(this,{_data:{},_propertyTracks:{},_timelinePropertyCaches:{},_timelinePropertyCacheIndex:[],_keyframeProperties:{},id:a.uniqueId(),setup:b.setup||t,update:b.update||t,teardown:b.teardown||t});b.context&&this.context(b.context);return this},r=function(){};r.prototype=c.prototype;d.prototype=new r;d.prototype.context=function(b){if(b)this._context=b;return this._context};d.prototype.keyframe=function(b,g,c){var e,c=c||"linear";"string"===typeof c&&(e=c,c={},
a.each(g,function(b,a){c[a]=e}));a.each(g,function(b,a){c[a]=c[a]||"linear"});a.each(g,function(a,g){var e=new p.KeyframeProperty(this,b,g,a,c[g]);this._keyframeProperties[e.id]=e;this._propertyTracks[g]||(this._propertyTracks[g]=[]);this._propertyTracks[g].push(e);n(this)},this);this.kapi&&this.kapi._recalculateAnimationLength();k(this);return this};d.prototype.getKeyframeProperty=function(b,a){if(this._propertyTracks[b]&&this._propertyTracks[b][a])return this._propertyTracks[b][a]};d.prototype.modifyKeyframeProperty=
function(b,a,c){this._propertyTracks[b]&&this._propertyTracks[b][a]&&this._propertyTracks[b][a].modifyWith(c);n(this);k(this);return this};d.prototype.getTrackNames=function(){return a.keys(this._propertyTracks)};d.prototype.getTrackLength=function(b){return!this._propertyTracks[b]?void 0:this._propertyTracks[b].length};d.prototype.copyProperties=function(b,c){var l={},e={};a.each(this._propertyTracks,function(b,a){var d=o(this,a,c);if(d)l[a]=d.value,e[a]=d.easing},this);this.keyframe(b,l,e);return this};
d.prototype.wait=function(b){var c=this.getEnd();if(b<=c)return this;var c=this.getEnd(),d=i(this,this.getEnd()),e={},j={};a.each(d,function(b,a){e[a]=b.value;j[a]=b.easing});this.removeKeyframe(c);this.keyframe(c,e,j);this.keyframe(b,e,j);return this};d.prototype.getStart=function(){var b=[];a.each(this._propertyTracks,function(a){a.length&&b.push(a[0].millisecond)});0===b.length&&(b=[0]);return Math.min.apply(Math,b)};d.prototype.getEnd=function(){var b=0;a.each(this._propertyTracks,function(c){if(c.length)c=
a.last(c).millisecond,c>b&&(b=c)},this);return b};d.prototype.getLength=function(){return this.getEnd()-this.getStart()};d.prototype.hasKeyframeAt=function(b,c){var d=this._propertyTracks;if(c){if(!a.has(d,c))return!1;d=a.pick(d,c)}return void 0!==a.find(d,function(a,c){return void 0!==o(this,c,b)},this)};d.prototype.modifyKeyframe=function(b,c,d){d=d||{};a.each(this._propertyTracks,function(a,j){var h=o(this,j,b);h&&h.modifyWith({value:c[j],easing:d[j]})},this);return this};d.prototype.removeKeyframe=
function(b){a.each(this._propertyTracks,function(c){var d=-1,e=!1;a.find(c,function(a){d++;return e=b===a.millisecond});e&&(c=c.splice(d,1)[0])&&delete this._keyframeProperties[c.id]},this);this.kapi&&this.kapi._recalculateAnimationLength();k(this);return this};d.prototype.removeAllKeyframeProperties=function(){a.each(this._propertyTracks,function(b){b.length=0},this);this._keyframeProperties={};return this.removeKeyframe(0)};d.prototype.updateState=function(b){var c=this.getStart(),d=this.getEnd();
if(c<=b&&b<=d){var c=this._timelinePropertyCaches[this._timelinePropertyCacheIndex[m(this,b)]],e={};a.each(c,function(a,c){a&&(e[c]=a.getValueAt(b))});this.set(e)}return this};d.prototype.data=function(b){if(b)this._data=b;return this._data};d.prototype.exportTimeline=function(){var b={start:this.getStart(),end:this.getEnd(),trackNames:this.getTrackNames(),propertyTracks:{}};a.each(this._propertyTracks,function(c,d){var e=b.propertyTracks[d]=[];a.each(c,function(b){e.push(b.exportPropertyData())})});
return b}},B=function(d,a,c){d=d.Kapi.KeyframeProperty=function(c,d,n,f,i){this.id=a.uniqueId("keyframeProperty_");this.ownerActor=c;this.millisecond=d;this.name=n;this.value=f;this.easing=i||"linear";this.nextProperty=null;return this};d.prototype.modifyWith=function(c){var d={};a.each(["millisecond","easing","value"],function(a){d[a]="undefined"===typeof c[a]?this[a]:c[a]},this);a.extend(this,d)};d.prototype.linkToNext=function(a){this.nextProperty=a||null};d.prototype.getValueAt=function(a){var d=
{},n={};this.nextProperty?(d[this.name]=this.value,n[this.name]=this.nextProperty.value,a=c.util.interpolate(d,n,(a-this.millisecond)/(this.nextProperty.millisecond-this.millisecond),this.nextProperty.easing)[this.name]):a=this.value;return a};d.prototype.exportPropertyData=function(){return{id:this.id,millisecond:this.millisecond,name:this.name,value:this.value,easing:this.easing}}},u=function(d,a){function c(a,c,d){"undefined"!==typeof d&&(a[c]=d,a.style[c]=d+"px");return a[c]}function h(a){a.config.clearOnUpdate&&
a.canvasClear()}function m(c){f(c,"beforeDraw",a);var d=c._drawOrder.length,h;c._drawOrderSorter?(h=a.sortBy(c._canvasActors,c._drawOrderSorter),h=a.pluck(h,"id")):h=c._drawOrder;var p,i,b;for(b=0;b<d;b++)p=c._canvasActors[h[b]],i=p.context(),p.draw(i,p.get());f(c,"afterDraw",a);return c}function n(a,c){c instanceof i.CanvasActor&&(a._drawOrder.push(c.id),a._canvasActors[c.id]=c)}function q(c,d){if(d instanceof i.CanvasActor)c._drawOrder=a.without(c._drawOrder,d.id),delete c._canvasActors[d.id]}var i=
d.Kapi;i.prototype._contextInitHook.canvas=function(){this._drawOrder=[];this._drawOrderSorter=null;this._canvasActors={};this.config.clearOnUpdate=!0;a.extend(this._events,{beforeDraw:[],afterDraw:[]});a.each(["Height","Width"],function(a){var c=a.toLowerCase();this.config[c]&&(this["canvas"+a](this.config[c]),delete this.config[a])},this);this.on("afterUpdate",m);this.on("addActor",n);this.on("removeActor",q);this.on("beforeDraw",h)};i.prototype.canvasHeight=function(a){return c(this.context,"height",
a)};i.prototype.canvasWidth=function(a){return c(this.context,"width",a)};i.prototype.canvasClear=function(){this.context.getContext&&this.canvasContext().clearRect(0,0,this.canvasWidth(),this.canvasHeight());return this};i.prototype.canvasContext=function(){return this.context.getContext("2d")};i.prototype.redraw=function(){m(this);return this};i.prototype.moveActorToLayer=function(c,d){if(d<this._drawOrder.length)return this._drawOrder=a.without(this._drawOrder,c.id),this._drawOrder.splice(d,0,
c.id),c};i.prototype.setOrderFunction=function(a){this._drawOrderSorter=a;return this};i.prototype.unsetOrderFunction=function(){this._drawOrderSorter=null;return this};i.prototype.exportTimeline=function(){var c={duration:this._animationLength,actorOrder:this._drawOrder.slice(0),actors:{}};a.each(this._drawOrder,function(a){c.actors[a]=this._actors[a].exportTimeline()},this);return c}},v=function(d){function a(){}var c=d.Kapi;a.prototype=c.Actor.prototype;d=c.CanvasActor=function(a){c.Actor.call(this,
a);a=a||{};this.draw=a.draw||t;return this};d.prototype=new a;d.prototype.context=function(a){if(a)this._context=a;return this._context&&this._context.getContext("2d")};d.prototype.moveToLayer=function(a){return this.kapi.moveActorToLayer(this,a)}},w=function(d,a){function c(){}var h=d.Kapi,m=["transform","webkitTransform","MozTransform","oTransform","msTransform"];h.DOMActor=function(a){h.Actor.call(this);this._context=a;a=this.getCSSName();this._context.className.match(a)||(this._context.className+=
" "+a);delete this.update;delete this.teardown;return this};c.prototype=h.Actor.prototype;h.DOMActor.prototype=new c;c.prototype.update=function(c,d){a.each(d,function(d,h){"transform"===h?a.each(m,function(a){c.style[a]=d},this):c.style[h]=d},this)};c.prototype.teardown=function(){var c=this._context.className.match(/\S+/g);this._context.className=a.without(c,this.getCSSName())};c.prototype.getCSSName=function(){return"actor-"+this.id}},x=function(d,a){function c(c){var d=["{"],b;a.each(c.get(),
function(a,c){b=a;var e=c;"transform"===c&&(e=q);d.push(e+":"+b+";")});d.push("}");return d.join("")}function h(c,d,b){var b=b||["w3"],g=[];a.each(b,function(a){a=k(j,[i[a],d,c]).replace(RegExp(q,"g"),i[a]+"transform");g.push(a)});return g.join("\n")}function m(c,d,b){var d=d||["w3"],g=[],h;a.each(d,function(a){var d=[],a=i[a],m=c.getStart(),f=c.getEnd()-m,f=k("  %sanimation-duration: %sms;",[a,f]);d.push(f);f=k("  %sanimation-name: %s;",[a,b+"-keyframes"]);d.push(f);m=k("  %sanimation-delay: %sms;",
[a,m]);d.push(m);a=k("  %sanimation-fill-mode: forwards;",[a]);d.push(a);h=d.join("\n");g.push(h)});return k(o,[b,g.join("\n")])}var f=d.Kapi,q="TRANSFORM",i=f.util.VENDOR_PREFIXES={microsoft:"-ms-",mozilla:"-moz-",opera:"-o-",w3:"",webkit:"-webkit-"},j="@%skeyframes %s-keyframes {\n%s\n}",o=".%s {\n  position: absolute;\n%s\n}";d.Kapi.prototype.toCSS=function(c){var c=c||{},d=[],b=this.getActorIds();a.each(b,function(a){d.push(this.getActor(a).toCSS(c))},this);return d.join("\n")};d.Kapi.Actor.prototype.toCSS=
function(a){var a=a||{},d=[],b=a.name||this.getCSSName(),g=a.granularity||100,i=m(this,a.vendors,b);d.push(i);var i=this.getLength(),e=this.getStart(),f=[],j,g=i/g,n=i/100,k=e+g,o=i+e-g;this.updateState(e);for(f.push("  from "+c(this));k<=o;k+=g)this.updateState(k),j=(k-e)/n,j=+j.toFixed(2),j+="% ",f.push("  "+j+c(this));this.updateState(i+e);f.push("  to "+c(this));i=f.join("\n");a=h(i,b,a.vendors);d.push(a);return d.join("\n")};var k=f.util.printf=function(c,d){var b=c;a.each(d,function(a){b=b.replace("%s",
a)});return b}},y=function(d,a){var c=a?{}:d,h=a&&a.underscore?a.underscore:c._,f=a&&a.Tweenable?a.Tweenable:c.Tweenable;z(c,h,f);A(c,h,f);B(c,h,f);"function"===typeof w&&w(c,h,f);"function"===typeof x&&x(c,h,f);"function"===typeof u&&u(c,h,f);"function"===typeof v&&v(c,h,f);return c.Kapi};if("function"===typeof define&&define.amd){var C="undefined"!==typeof _;define(["shifty","underscore"],function(d,a){var c=null!==a,h={Tweenable:d,underscore:c?a:_},f=y(s,h);if("undefined"!==typeof KAPI_DEBUG&&
!0===KAPI_DEBUG)f.underscore_version=h.underscore.VERSION;if(!C&&c)s._=void 0;return f})}else y("undefined"!==typeof s?s:this)})(this);
